<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARTINE v17.0 - Version Compl√®te SNCF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .project-martine {
            background: linear-gradient(45deg, #003366, #0066CC, #CC0000, #E30613);
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .save-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            backdrop-filter: blur(5px);
        }

        .tabs-container {
            display: flex;
            background: rgba(255,255,255,0.9);
            padding: 0 20px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 600;
            color: #666;
            background: none;
            border: none;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .main-content {
            background: rgba(255,255,255,0.95);
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 200px);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* üîß FILTRES AVANC√âS */
        .filters-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .filters-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* üöÄ ZONE IMPORT OPTIMIS√âE */
        .import-export-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .import-export-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .import-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-method {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .import-method:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .import-method h5 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .import-method p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* üìÅ ZONE FICHIER CORRIG√âE */
        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-drop-zone:hover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .file-drop-zone.dragover {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
            transform: scale(1.02);
        }

        .file-input-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 1;
        }

        /* üìã ZONE COPIER-COLLER */
        .paste-area {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            display: none;
        }

        .paste-area.active {
            display: block;
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.02);
        }

        .paste-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .paste-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* üîç FEN√äTRE DE PR√âVISUALISATION */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .preview-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 95%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .preview-header h3 {
            color: #2c3e50;
            font-size: 22px;
            margin: 0;
        }

        .close-preview {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .preview-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .preview-stat {
            text-align: center;
        }

        .preview-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .preview-stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .preview-stat.error .preview-stat-number {
            color: #dc3545;
        }

        .preview-stat.warning .preview-stat-number {
            color: #ffc107;
        }

        .preview-stat.success .preview-stat-number {
            color: #28a745;
        }

        /* üé® STATISTIQUES LUDIQUES */
        .stats-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin: 0 30px 20px;
        }

        .fun-badge {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #2c3e50;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .stat-chip-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .stat-chip {
            background: rgba(255,255,255,0.85);
            border: 2px dashed rgba(102, 126, 234, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stat-chip-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #667eea;
            font-weight: 700;
        }

        .stat-chip-value {
            font-size: 22px;
            font-weight: 800;
            color: #2c3e50;
            margin-top: 2px;
        }

        .stat-chip-subtext {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .accent-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.12), rgba(118, 75, 162, 0.12));
            border: 1px solid rgba(102, 126, 234, 0.25);
        }

        .rg-change-list {
            margin-top: 12px;
            display: grid;
            gap: 10px;
        }

        .rg-change-item {
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .rg-change-item strong {
            color: #2c3e50;
        }

        .rg-change-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #6c757d;
        }

        .rg-change-meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(102, 126, 234, 0.1);
        }

        /* üìä TABLEAU DE PR√âVISUALISATION */
        .preview-table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            position: relative;
            word-break: break-word;
            white-space: normal;
        }

        .preview-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        /* ‚úèÔ∏è CELLULES √âDITABLES */
        .editable-cell {
            position: relative;
            cursor: pointer;
            min-height: 20px;
        }

        .editable-cell:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .editable-cell.editing {
            padding: 0;
        }

        .editable-cell input {
            width: 100%;
            border: none;
            padding: 10px 8px;
            font-size: 13px;
            background: white;
            outline: none;
        }

        .editable-cell input:focus {
            box-shadow: inset 0 0 0 2px #667eea;
        }

        /* üü† INDICATEURS DE VALIDATION */
        .validation-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: help;
        }

        .validation-indicator.error {
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .validation-indicator.warning {
            background: #ffc107;
        }

        .validation-indicator.success {
            background: #28a745;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* üîß BOUTONS */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: white;
        }

        .btn-excel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* üìä TABLEAU PRINCIPAL */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            word-break: break-word;
            white-space: normal;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            word-break: break-word;
            white-space: normal;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .row-number {
            background: #f8f9fa;
            font-weight: bold;
            text-align: center;
            color: #667eea;
            width: 50px;
        }

        input.editable,
        textarea.editable {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
            line-height: 1.4;
        }

        textarea.editable {
            resize: vertical;
            min-height: 38px;
            overflow: hidden;
            white-space: pre-wrap;
        }

        input.editable:focus,
        textarea.editable:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.editable.has-error,
        textarea.editable.has-error {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.05);
        }

        input.editable.has-warning,
        textarea.editable.has-warning {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.05);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        /* üìä STATISTIQUES */
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stats-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: 600;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* üìä DASHBOARD STATISTIQUES */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* üîî NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1001;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }

        /* üí° TOOLTIP */
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1002;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* üè¢ CR√âDIT PRODUCTEUR */
        .producer-credit {
            position: fixed;
            bottom: 10px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        /* üì± RESPONSIVE */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .import-methods {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preview-content {
                max-width: 98%;
                max-height: 95%;
                padding: 15px;
            }
            
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* üìù SP√âCIFIQUE T√ÇCHES */
        .task-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .task-field {
            margin-bottom: 15px;
        }

        .task-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .task-field input,
        .task-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* üîç SP√âCIFIQUE RECHERCHE */
        .search-results-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            border-radius: 12px 12px 0 0;
        }

        .search-results-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .result-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .result-row:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .highlight-result {
            background-color: rgba(102, 126, 234, 0.2);
            animation: fadeHighlight 2s ease-out;
        }

        @keyframes fadeHighlight {
            0% { background-color: rgba(102, 126, 234, 0.4); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="save-status" id="saveStatus">üíæ Auto-sauvegarde activ√©e</div>
        <h1>Suivi Mise en Qualit√© - SNCF PROJECT <span class="project-martine">M.A.R.T.I.N.E V17</span></h1>
        <div class="controls" style="justify-content: center; margin-top: 15px;">
            <button class="btn btn-excel" onclick="exportAllToExcel()">üìä Export Global Excel</button>
            <button class="btn btn-primary" onclick="exportCompleteBackup()">üì§ T√©l√©charger Sauvegarde</button>
            <button class="btn btn-primary" onclick="importCompleteBackup()">üì• Importer Sauvegarde</button>
            <input type="file" id="backupFileInput" accept="application/json" style="display: none;" onchange="handleBackupImport()">
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab active" onclick="switchTab('creation')">üìù Cr√©ation</button>
        <button class="tab" onclick="switchTab('modification')">üîÑ Modification RG</button>
        <button class="tab" onclick="switchTab('resiliation')">‚ùå R√©siliation</button>
        <button class="tab" onclick="switchTab('autremodif')">üîß Autre modification</button>
        <button class="tab" onclick="switchTab('modifsurface')">üìê Modification surface</button>
        <button class="tab" onclick="switchTab('verifbaux')">‚úÖ V√©rification baux</button>
        <button class="tab" onclick="switchTab('baserg')">üóÇÔ∏è Base RG</button>
        <button class="tab" onclick="switchTab('taches')">üìù T√¢ches √† faire</button>
        <button class="tab" onclick="switchTab('statistiques')">üìä Statistiques</button>
        <button class="tab" onclick="switchTab('recherche')">üîç Recherche</button>
    </div>

    <div class="main-content">
        <!-- ONGLET CR√âATION -->
        <div id="creation" class="tab-content active">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterCreationGA" placeholder="Filtrer par GA..." oninput="filterTable('creation')">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="filterCreationDateFrom" onchange="filterTable('creation')">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="filterCreationDateTo" onchange="filterTable('creation')">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="filterCreationStatus" onchange="filterTable('creation')">
                            <option value="">Tous</option>
                            <option value="traite">Trait√©</option>
                            <option value="attente">En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>RG</label>
                        <input type="text" id="filterCreationRG" placeholder="Filtrer par RG..." oninput="filterTable('creation')">
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterCreationUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('creation')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Glissez-d√©posez votre fichier Excel ou cliquez pour s√©lectionner. Validation automatique des donn√©es selon les r√®gles SNCF.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('creation')">
                            <input type="file" class="file-input-hidden" id="fileInputCreation" accept=".xlsx,.xls,.csv" onchange="handleFileImport('creation', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Formats: .xlsx, .xls, .csv</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Copiez vos donn√©es depuis Excel et collez-les ici. Pr√©visualisation avec correction possible avant import.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('creation')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaCreation">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaCreation" 
                                      placeholder="S√©lectionnez vos donn√©es dans Excel (Ctrl+C) puis collez ici (Ctrl+V)..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('creation')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('creation')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('creation')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('creation')">üìä Exporter Excel</button>
                <button class="btn btn-danger" onclick="clearAll('creation')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="creationTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 120px;">Date Demande</th>
                            <th style="width: 120px;">Date Traitement</th>
                            <th style="width: 80px;">RG</th>
                            <th style="width: 200px;">Nom de RG</th>
                            <th style="width: 120px;">Num√©ro de Bail</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 250px;">Commentaires</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="creationTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="creationTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Trait√©s: <span id="creationProcessedRows">0</span></div>
                <div class="stats-item">‚è≥ En attente: <span id="creationPendingRows">0</span></div>
                <div class="stats-item">üìà Taux: <span id="creationCompletionRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET MODIFICATION RG -->
        <div id="modification" class="tab-content">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterModificationGA" placeholder="Filtrer par GA..." oninput="filterTable('modification')">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="filterModificationDateFrom" onchange="filterTable('modification')">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="filterModificationDateTo" onchange="filterTable('modification')">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="filterModificationStatus" onchange="filterTable('modification')">
                            <option value="">Tous</option>
                            <option value="traite">Trait√©</option>
                            <option value="attente">En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>RG</label>
                        <input type="text" id="filterModificationRG" placeholder="Filtrer par RG..." oninput="filterTable('modification')">
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterModificationUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('modification')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import de fichiers Excel avec validation des codes RG, GA et num√©ros de bail.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('modification')">
                            <input type="file" class="file-input-hidden" id="fileInputModification" accept=".xlsx,.xls,.csv" onchange="handleFileImport('modification', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Validation automatique</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Collez vos donn√©es directement depuis Excel avec pr√©visualisation interactive.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('modification')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaModification">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaModification" 
                                      placeholder="Collez vos donn√©es Excel ici..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('modification')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('modification')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('modification')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('modification')">üìä Exporter Excel</button>
                <button class="btn btn-danger" onclick="clearAll('modification')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="modificationTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 120px;">Date Demande</th>
                            <th style="width: 120px;">Date Traitement</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 80px;">RG</th>
                            <th style="width: 200px;">Nom de RG</th>
                            <th style="width: 120px;">Num√©ro de Bail</th>
                            <th style="width: 250px;">Commentaires</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modificationTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="modificationTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Trait√©s: <span id="modificationProcessedRows">0</span></div>
                <div class="stats-item">‚è≥ En attente: <span id="modificationPendingRows">0</span></div>
                <div class="stats-item">üìà Taux: <span id="modificationCompletionRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET R√âSILIATION -->
        <div id="resiliation" class="tab-content">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterResiliationGA" placeholder="Filtrer par GA..." oninput="filterTable('resiliation')">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="filterResiliationDateFrom" onchange="filterTable('resiliation')">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="filterResiliationDateTo" onchange="filterTable('resiliation')">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="filterResiliationStatus" onchange="filterTable('resiliation')">
                            <option value="">Tous</option>
                            <option value="traite">Trait√©</option>
                            <option value="attente">En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterResiliationUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('resiliation')">
                    </div>
                    <div class="filter-group">
                        <label>Num√©ro Bail</label>
                        <input type="text" id="filterResiliationBail" placeholder="Filtrer par bail..." oninput="filterTable('resiliation')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import de donn√©es de r√©siliation avec validation automatique GA et num√©ros de bail.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('resiliation')">
                            <input type="file" class="file-input-hidden" id="fileInputResiliation" accept=".xlsx,.xls,.csv" onchange="handleFileImport('resiliation', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Validation GA et Num√©ros de bail</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Collage direct avec pr√©visualisation et correction des donn√©es de r√©siliation.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('resiliation')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaResiliation">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaResiliation" 
                                      placeholder="Collez vos donn√©es Excel ici..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('resiliation')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('resiliation')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('resiliation')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('resiliation')">üìä Exporter Excel</button>
                <button class="btn btn-danger" onclick="clearAll('resiliation')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="resiliationTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 120px;">Date Demande</th>
                            <th style="width: 120px;">Date Traitement</th>
                            <th style="width: 120px;">Num√©ro de Bail</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 300px;">Commentaires</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="resiliationTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="resiliationTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Trait√©s: <span id="resiliationProcessedRows">0</span></div>
                <div class="stats-item">‚è≥ En attente: <span id="resiliationPendingRows">0</span></div>
                <div class="stats-item">üìà Taux: <span id="resiliationCompletionRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET AUTRE MODIFICATION -->
        <div id="autremodif" class="tab-content">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterAutremodifGA" placeholder="Filtrer par GA..." oninput="filterTable('autremodif')">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="filterAutremodifDateFrom" onchange="filterTable('autremodif')">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="filterAutremodifDateTo" onchange="filterTable('autremodif')">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="filterAutremodifStatus" onchange="filterTable('autremodif')">
                            <option value="">Tous</option>
                            <option value="traite">Trait√©</option>
                            <option value="attente">En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Type Modification</label>
                        <input type="text" id="filterAutremodifType" placeholder="Filtrer par type..." oninput="filterTable('autremodif')">
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterAutremodifUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('autremodif')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import de donn√©es de modifications diverses avec validation automatique.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('autremodif')">
                            <input type="file" class="file-input-hidden" id="fileInputAutremodif" accept=".xlsx,.xls,.csv" onchange="handleFileImport('autremodif', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Validation automatique</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Collage direct avec validation des donn√©es de modifications.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('autremodif')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaAutremodif">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaAutremodif" 
                                      placeholder="Collez vos donn√©es Excel ici..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('autremodif')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('autremodif')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('autremodif')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('autremodif')">üìä Exporter Excel</button>
                <button class="btn btn-danger" onclick="clearAll('autremodif')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="autremodifTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 120px;">Date Demande</th>
                            <th style="width: 120px;">Date Traitement</th>
                            <th style="width: 120px;">Num√©ro de Bail</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 150px;">Type Modification</th>
                            <th style="width: 250px;">Commentaires</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="autremodifTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="autremodifTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Trait√©s: <span id="autremodifProcessedRows">0</span></div>
                <div class="stats-item">‚è≥ En attente: <span id="autremodifPendingRows">0</span></div>
                <div class="stats-item">üìà Taux: <span id="autremodifCompletionRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET MODIFICATION SURFACE -->
        <div id="modifsurface" class="tab-content">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterModifsurfaceGA" placeholder="Filtrer par GA..." oninput="filterTable('modifsurface')">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="filterModifsurfaceDateFrom" onchange="filterTable('modifsurface')">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="filterModifsurfaceDateTo" onchange="filterTable('modifsurface')">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="filterModifsurfaceStatus" onchange="filterTable('modifsurface')">
                            <option value="">Tous</option>
                            <option value="traite">Trait√©</option>
                            <option value="attente">En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterModifsurfaceUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('modifsurface')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import avec calcul automatique des diff√©rences de surface. Les diff√©rences sont calcul√©es automatiquement (+ - -).</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('modifsurface')">
                            <input type="file" class="file-input-hidden" id="fileInputModifsurface" accept=".xlsx,.xls,.csv" onchange="handleFileImport('modifsurface', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Calcul automatique des diff√©rences</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Collage avec validation des surfaces num√©riques et calcul automatique.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('modifsurface')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaModifsurface">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaModifsurface" 
                                      placeholder="Collez vos donn√©es Excel ici..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('modifsurface')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('modifsurface')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('modifsurface')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('modifsurface')">üìä Exporter Excel</button>
                <button class="btn btn-warning" onclick="recalculateAllSurfaces()">üîÑ Recalculer toutes les diff√©rences</button>
                <button class="btn btn-danger" onclick="clearAll('modifsurface')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="modifsurfaceTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 120px;">Date Demande</th>
                            <th style="width: 120px;">Date Traitement</th>
                            <th style="width: 120px;">Num√©ro de Bail</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 100px;">-</th>
                            <th style="width: 100px;">+</th>
                            <th style="width: 100px;">Diff√©rence</th>
                            <th style="width: 200px;">Commentaires</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modifsurfaceTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES SP√âCIALIS√âES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="modifsurfaceTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Trait√©s: <span id="modifsurfaceProcessedRows">0</span></div>
                <div class="stats-item">‚è≥ En attente: <span id="modifsurfacePendingRows">0</span></div>
                <div class="stats-item">üìà Surface totale modifi√©e: <span id="modifsurfaceTotalDifference">0 m¬≤</span></div>
                <div class="stats-item">üìà Taux: <span id="modifsurfaceCompletionRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET V√âRIFICATION BAUX -->
        <div id="verifbaux" class="tab-content">
            <!-- FILTRES -->
            <div class="filters-section">
                <h4>üîç Filtres avanc√©s</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="filterVerifbauxGA" placeholder="Filtrer par GA..." oninput="filterTable('verifbaux')">
                    </div>
                    <div class="filter-group">
                        <label>RG</label>
                        <input type="text" id="filterVerifbauxRG" placeholder="Filtrer par RG..." oninput="filterTable('verifbaux')">
                    </div>
                    <div class="filter-group">
                        <label>√âtat</label>
                        <select id="filterVerifbauxEtat" onchange="filterTable('verifbaux')">
                            <option value="">Tous</option>
                            <option value="OK">OK</option>
                            <option value="NOK">NOK</option>
                            <option value="EN COURS">EN COURS</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>R√©gion</label>
                        <input type="text" id="filterVerifbauxRegion" placeholder="Filtrer par r√©gion..." oninput="filterTable('verifbaux')">
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="filterVerifbauxUTBAT" placeholder="Filtrer par UT-BAT..." oninput="filterTable('verifbaux')">
                    </div>
                    <div class="filter-group">
                        <label>Lieu</label>
                        <input type="text" id="filterVerifbauxLieu" placeholder="Filtrer par lieu..." oninput="filterTable('verifbaux')">
                    </div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üöÄ Import/Export Excel avec Validation</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import avec validation stricte des √©tats (OK/NOK/EN COURS) et v√©rification des codes RG contre la base.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('verifbaux')">
                            <input type="file" class="file-input-hidden" id="fileInputVerifbaux" accept=".xlsx,.xls,.csv" onchange="handleFileImport('verifbaux', this)">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Validation des √©tats OK/NOK/EN COURS</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Collage avec validation automatique des donn√©es de v√©rification.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('verifbaux')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaVerifbaux">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Excel</h5>
                            <textarea class="paste-textarea" id="pasteTextareaVerifbaux" 
                                      placeholder="Collez vos donn√©es Excel ici..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('verifbaux')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('verifbaux')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('verifbaux')">‚ûï Ajouter ligne</button>
                <button class="btn btn-excel" onclick="exportToExcel('verifbaux')">üìä Exporter Excel</button>
                <button class="btn btn-warning" onclick="validateAllBauxStates()">üîç Valider tous les √©tats</button>
                <button class="btn btn-success" onclick="markAllAsOK()">‚úÖ Marquer s√©lection OK</button>
                <button class="btn btn-danger" onclick="clearAll('verifbaux')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU -->
            <div class="table-container">
                <table id="verifbauxTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 80px;">GA</th>
                            <th style="width: 100px;">UT-BAT</th>
                            <th style="width: 80px;">RG</th>
                            <th style="width: 120px;">Num√©ro Bail</th>
                            <th style="width: 100px;">√âtat</th>
                            <th style="width: 150px;">Lieu</th>
                            <th style="width: 150px;">Nom du B√¢timent</th>
                            <th style="width: 100px;">R√©gion</th>
                            <th style="width: 200px;">Commentaire</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verifbauxTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES SP√âCIALIS√âES -->
            <div class="stats">
                <div class="stats-item">üìä Total: <span id="verifbauxTotalRows">0</span></div>
                <div class="stats-item" style="color: #28a745;">‚úÖ OK: <span id="verifbauxOKRows">0</span></div>
                <div class="stats-item" style="color: #dc3545;">‚ùå NOK: <span id="verifbauxNOKRows">0</span></div>
                <div class="stats-item" style="color: #ffc107;">‚è≥ En cours: <span id="verifbauxEnCoursRows">0</span></div>
                <div class="stats-item">üìà Taux de validation: <span id="verifbauxValidationRate">0%</span></div>
            </div>
        </div>

            <!-- ONGLET BASE RG -->
        <div id="baserg" class="tab-content">
            <datalist id="rgDatalist"></datalist>
            <datalist id="rgNomDatalist"></datalist>
            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h4>üóÇÔ∏è Gestion de la Base RG - R√©f√©rentiel des Codes</h4>
                <div class="import-methods">
                    <div class="import-method">
                        <h5>üìÅ Import fichier Excel</h5>
                        <p>Import de la base de r√©f√©rence des codes RG avec validation et d√©tection des doublons.</p>
                        <div class="file-drop-zone" onclick="triggerFileInput('baserg')">
                            <input type="file" class="file-input-hidden" id="fileInputBaserg" accept=".xlsx,.xls,.csv" onchange="handleFileImport('baserg', this)">
                            <div style="font-size: 48px; color: #667eea; margin-bottom: 15px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Cliquez ou glissez votre fichier</div>
                            <div style="color: #666; font-size: 14px;">Base de r√©f√©rence RG</div>
                        </div>
                    </div>

                    <div class="import-method">
                        <h5>üìã Copier-Coller Excel</h5>
                        <p>Mise √† jour rapide de la base RG par copier-coller avec validation automatique.</p>
                        <button class="btn btn-primary" onclick="togglePasteArea('baserg')">üìã Ouvrir zone de collage</button>
                        
                        <div class="paste-area" id="pasteAreaBaserg">
                            <h5 style="margin-bottom: 15px; color: #2c3e50;">üìã Zone de collage Base RG</h5>
                            <textarea class="paste-textarea" id="pasteTextareaBaserg" 
                                      placeholder="Collez vos codes RG et leurs noms ici (format: Code | Nom)..."></textarea>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzePastedData('baserg')">üîç Analyser et pr√©visualiser</button>
                                <button class="btn btn-danger" onclick="togglePasteArea('baserg')">‚ùå Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTRES SP√âCIALIS√âS -->
            <div class="filters-section">
                <h4>üîç Recherche dans la Base RG</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Code RG</label>
                        <input type="text" id="filterBasergCode" placeholder="Rechercher par code..." oninput="filterTable('baserg')">
                    </div>
                    <div class="filter-group">
                        <label>Nom de RG</label>
                        <input type="text" id="filterBasergNom" placeholder="Rechercher par nom..." oninput="filterTable('baserg')">
                    </div>
                    <div class="filter-group">
                        <label>Statut d'utilisation</label>
                        <select id="filterBasergUsage" onchange="filterTable('baserg')">
                            <option value="">Tous</option>
                            <option value="utilise">Utilis√©</option>
                            <option value="inutilise">Non utilis√©</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CONTR√îLES -->
            <div class="controls">
                <button class="btn btn-primary" onclick="addRow('baserg')">‚ûï Ajouter code RG</button>
                <button class="btn btn-excel" onclick="exportToExcel('baserg')">üìä Exporter Base RG</button>
                <button class="btn btn-warning" onclick="validateAllRGCodes()">üîç V√©rifier codes RG dans tous les onglets</button>
                <button class="btn btn-success" onclick="buildRGDatabase()">üîÑ Reconstruire index RG</button>
                <button class="btn btn-danger" onclick="clearAll('baserg')">üóëÔ∏è Effacer tout</button>
            </div>

            <!-- TABLEAU BASE RG -->
            <div class="table-container">
                <table id="basergTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 150px;">Code RG</th>
                            <th style="width: 400px;">Nom de RG</th>
                            <th style="width: 100px;">Utilisations</th>
                            <th style="width: 120px;">Derni√®re utilisation</th>
                            <th style="width: 50px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="basergTableBody">
                    </tbody>
                </table>
            </div>

            <!-- STATISTIQUES BASE RG -->
            <div class="stats">
                <div class="stats-item">üìä Total codes: <span id="basergTotalRows">0</span></div>
                <div class="stats-item">‚úÖ Utilis√©s: <span id="basergUsedRows">0</span></div>
                <div class="stats-item">‚ö†Ô∏è Non utilis√©s: <span id="basergUnusedRows">0</span></div>
                <div class="stats-item">üîç Taux d'utilisation: <span id="basergUsageRate">0%</span></div>
            </div>
        </div>

        <!-- ONGLET T√ÇCHES √Ä FAIRE -->
        <div id="taches" class="tab-content">
            <div class="stats-dashboard">
                <div class="stats-card">
                    <h3>üìù Cr√©er une nouvelle t√¢che</h3>
                    <div class="task-form">
                        <div class="task-field">
                            <label>Onglet de destination :</label>
                            <select id="taskTargetTab" onchange="updateTaskFields()">
                                <option value="">S√©lectionner un onglet...</option>
                                <option value="creation">üìù Cr√©ation</option>
                                <option value="modification">üîÑ Modification RG</option>
                                <option value="resiliation">‚ùå R√©siliation</option>
                                <option value="autremodif">üîß Autre modification</option>
                                <option value="modifsurface">üìê Modification surface</option>
                                <option value="verifbaux">‚úÖ V√©rification baux</option>
                            </select>
                        </div>
                        
                        <div id="taskFieldsContainer">
                            <p style="color: #666; text-align: center; padding: 20px;">
                                S√©lectionnez un onglet pour voir les champs disponibles
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" id="transferTaskBtn" onclick="transferTask()" disabled>
                                üöÄ Transf√©rer vers l'onglet
                            </button>
                            <button class="btn btn-warning" id="pendingTaskBtn" onclick="saveTaskAsPending()" disabled>
                                ‚è≥ Mettre en attente
                            </button>
                            <button class="btn btn-primary" id="batchTaskBtn" onclick="addTaskToBatch()" disabled>
                                ‚ûï Ajouter au lot
                            </button>
                            <button class="btn btn-danger" onclick="clearTaskForm()">
                                üóëÔ∏è Effacer formulaire
                            </button>
                        </div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üìä Statistiques des t√¢ches</h3>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div>
                                <div class="preview-stat-number warning" id="pendingTasksCount">0</div>
                                <div class="preview-stat-label">En attente</div>
                            </div>
                            <div>
                                <div class="preview-stat-number success" id="completedTasksCount">0</div>
                                <div class="preview-stat-label">Compl√©t√©es</div>
                            </div>
                            <div>
                                <div class="preview-stat-number" id="totalTasksCount">0</div>
                                <div class="preview-stat-label">Total</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="tasksProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="executeAllPendingTasks()">üöÄ Ex√©cuter toutes les t√¢ches</button>
                        <button class="btn btn-danger" onclick="clearAllPendingTasks()">üóëÔ∏è Effacer toutes les t√¢ches</button>
                    </div>
                </div>
            </div>

            <!-- TABLEAU DES T√ÇCHES EN ATTENTE -->
            <div class="table-container" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4>üì¶ Lot de t√¢ches √† cr√©er</h4>
                    <button class="btn btn-success" id="createBatchTasksBtn" onclick="saveBatchAsPending()" disabled>
                        üöÄ Cr√©er toutes les t√¢ches du lot
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 180px;">Onglet</th>
                            <th style="width: 320px;">R√©sum√©</th>
                            <th style="width: 140px;">Date ajout</th>
                            <th style="width: 160px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="taskBatchTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">‚ûï Ajoutez des t√¢ches pour constituer un lot.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TABLEAU DES T√ÇCHES EN ATTENTE -->
            <div class="table-container">
                <table id="tachesTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 150px;">Onglet destination</th>
                            <th style="width: 300px;">R√©sum√©</th>
                            <th style="width: 120px;">Date cr√©ation</th>
                            <th style="width: 100px;">Priorit√©</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tachesTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                üìù Aucune t√¢che en attente. Cr√©ez une nouvelle t√¢che ci-dessus !
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ONGLET STATISTIQUES -->
        <div id="statistiques" class="tab-content">
            <div class="stats-actions">
                <div class="fun-badge">üéâ Stats ludiques activ√©es</div>
                <div class="stat-chip-row">
                    <div class="stat-chip">
                        <div class="stat-chip-label">Progression globale</div>
                        <div class="stat-chip-value" id="chipOverallRate">0%</div>
                        <div class="stat-chip-subtext" id="chipOverallSummary">Aucune donn√©e pour le moment</div>
                    </div>
                    <div class="stat-chip">
                        <div class="stat-chip-label">UT-BAT sous surveillance</div>
                        <div class="stat-chip-value" id="chipRgMultiCount">0</div>
                        <div class="stat-chip-subtext" id="chipRgDetails">Aucun doublon d√©tect√©</div>
                    </div>
                    <div class="stat-chip">
                        <div class="stat-chip-label">Alertes qualit√©</div>
                        <div class="stat-chip-value" id="chipQualityAlerts">0</div>
                        <div class="stat-chip-subtext" id="chipQualitySummary">Pas d'alerte √† signaler</div>
                    </div>
                </div>
                <button class="btn btn-excel" onclick="exportStatsReport()">üì§ Exporter toutes les statistiques</button>
            </div>

            <!-- VUE D'ENSEMBLE -->
            <div class="stats-dashboard">
                <div class="stats-card">
                    <h3>üìä Vue d'ensemble globale</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div class="preview-stat-number" id="totalGeneral">0</div>
                            <div class="preview-stat-label">Total entr√©es</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="preview-stat-number success" id="traitesGeneral">0</div>
                            <div class="preview-stat-label">Trait√©s</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="preview-stat-number warning" id="attenteGeneral">0</div>
                            <div class="preview-stat-label">En attente</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="preview-stat-number" id="tauxGeneral">0%</div>
                            <div class="preview-stat-label">Taux global</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressGeneral" style="width: 0%"></div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üéØ Contr√¥les qualit√©</h3>
                    <div id="qualityStatus" style="padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                        <div style="font-size: 18px; font-weight: 600; color: #667eea;">Analyse en cours...</div>
                        <div style="color: #666; margin-top: 10px;">V√©rification automatique des donn√©es</div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üìà Activit√© r√©cente</h3>
                    <div id="recentActivity">
                        <div style="color: #666; text-align: center; padding: 20px;">
                            Chargement des activit√©s r√©centes...
                        </div>
                    </div>
                </div>

                <div class="stats-card accent-card">
                    <h3>üåÄ Changements de RG surveill√©s</h3>
                    <div id="rgChangeMood" class="stat-chip-subtext" style="margin-bottom: 10px;">Analyse en cours...</div>
                    <div class="stat-chip-row" style="margin-bottom: 10px;">
                        <div class="stat-chip">
                            <div class="stat-chip-label">UT-BAT suivis</div>
                            <div class="stat-chip-value" id="rgChangeUTBATCount">0</div>
                            <div class="stat-chip-subtext">Pr√©sents dans les modifications RG</div>
                        </div>
                        <div class="stat-chip">
                            <div class="stat-chip-label">Changements multiples</div>
                            <div class="stat-chip-value" id="rgChangeMultiCount">0</div>
                            <div class="stat-chip-subtext">UT-BAT modifi√©s plusieurs fois</div>
                        </div>
                    </div>
                    <div class="rg-change-list" id="rgChangeDetails">
                        <div style="color: #666;">Aucun UT-BAT avec modifications r√©p√©t√©es pour le moment.</div>
                    </div>
                </div>
            </div>

            <!-- STATISTIQUES PAR ONGLET -->
            <div class="stats-dashboard" id="individualStats">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- GRAPHIQUES -->
            <div class="stats-dashboard">
                <div class="stats-card">
                    <h3>üìà R√©partition par onglet</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="tabsChart"></canvas>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üìä √âvolution des traitements</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üéØ √âtats de v√©rification</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="verificationChart"></canvas>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>üìê Modifications de surface</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="surfaceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ONGLET RECHERCHE -->
        <div id="recherche" class="tab-content">
            <div class="import-export-section">
                <h4>üîç Recherche multi-crit√®res avanc√©e</h4>
                <div class="filters-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
                    <div class="filter-group">
                        <label>GA</label>
                        <input type="text" id="searchGA" placeholder="Rechercher par GA...">
                    </div>
                    <div class="filter-group">
                        <label>Code RG</label>
                        <input type="text" id="searchRG" placeholder="Rechercher par RG...">
                    </div>
                    <div class="filter-group">
                        <label>UT-BAT</label>
                        <input type="text" id="searchUTBAT" placeholder="Rechercher par UT-BAT...">
                    </div>
                    <div class="filter-group">
                        <label>Num√©ro de Bail</label>
                        <input type="text" id="searchBail" placeholder="Rechercher par bail...">
                    </div>
                    <div class="filter-group">
                        <label>Date de</label>
                        <input type="date" id="searchDateFrom">
                    </div>
                    <div class="filter-group">
                        <label>Date √†</label>
                        <input type="date" id="searchDateTo">
                    </div>
                    <div class="filter-group">
                        <label>Onglet</label>
                        <select id="searchTab">
                            <option value="">Tous les onglets</option>
                            <option value="creation">üìù Cr√©ation</option>
                            <option value="modification">üîÑ Modification RG</option>
                            <option value="resiliation">‚ùå R√©siliation</option>
                            <option value="autremodif">üîß Autre modification</option>
                            <option value="modifsurface">üìê Modification surface</option>
                            <option value="verifbaux">‚úÖ V√©rification baux</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Mot-cl√© libre</label>
                        <input type="text" id="searchKeyword" placeholder="Recherche libre...">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="performSearch()">üîç Lancer la recherche</button>
                    <button class="btn btn-warning" onclick="performAdvancedSearch()">üéØ Recherche avanc√©e</button>
                    <button class="btn btn-danger" onclick="clearSearch()">üóëÔ∏è Effacer crit√®res</button>
                    <button class="btn btn-excel" onclick="exportSearchResults()">üìä Exporter r√©sultats</button>
                </div>

                <!-- Options de recherche avanc√©e -->
                <div class="filters-section" id="advancedSearchOptions" style="display: none;">
                    <h4>üéØ Options de recherche avanc√©e</h4>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Type de recherche</label>
                            <select id="searchType">
                                <option value="contains">Contient</option>
                                <option value="exact">Correspond exactement</option>
                                <option value="starts">Commence par</option>
                                <option value="ends">Finit par</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Num√©ro de bail (avanc√©)</label>
                            <input type="text" id="advancedSearchBail" placeholder="Filtrer par num√©ro de bail...">
                        </div>
                        <div class="filter-group">
                            <label>Statut des donn√©es</label>
                            <select id="searchStatus">
                                <option value="all">Toutes</option>
                                <option value="processed">Trait√©es seulement</option>
                                <option value="pending">En attente seulement</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√âSULTATS DE RECHERCHE -->
            <div class="table-container" id="searchResults" style="display: none;">
                <div class="search-results-header">
                    <h4>üìä R√©sultats de recherche : <span id="searchResultsCount">0</span> √©l√©ment(s) trouv√©(s)</h4>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Temps de recherche: <span id="searchTime">0</span>ms | 
                        Crit√®res: <span id="searchCriteria">Aucun</span>
                    </div>
                </div>
                <table>
                    <thead id="searchResultsHead">
                        <!-- G√©n√©r√© dynamiquement -->
                    </thead>
                    <tbody id="searchResultsBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>

            <!-- RECHERCHES SAUVEGARD√âES -->
            <div class="stats-card" style="margin-top: 20px;">
                <h3>üíæ Recherches sauvegard√©es</h3>
                <div id="savedSearches">
                    <p style="color: #666; text-align: center; padding: 20px;">
                        Aucune recherche sauvegard√©e. Effectuez une recherche et cliquez sur "Sauvegarder" pour la retrouver ici.
                    </p>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="saveCurrentSearch()" id="saveSearchBtn" disabled>
                        üíæ Sauvegarder cette recherche
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FEN√äTRE DE PR√âVISUALISATION -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="previewTitle">üîç Pr√©visualisation des donn√©es</h3>
                <button class="close-preview" onclick="closePreview()">√ó</button>
            </div>
            
            <div class="preview-stats" id="previewStats">
                <div class="preview-stat success">
                    <div class="preview-stat-number" id="previewValidCount">0</div>
                    <div class="preview-stat-label">Valides</div>
                </div>
                <div class="preview-stat error">
                    <div class="preview-stat-number" id="previewErrorCount">0</div>
                    <div class="preview-stat-label">Erreurs</div>
                </div>
                <div class="preview-stat warning">
                    <div class="preview-stat-number" id="previewWarningCount">0</div>
                    <div class="preview-stat-label">Avertissements</div>
                </div>
                <div class="preview-stat">
                    <div class="preview-stat-number" id="previewTotalCount">0</div>
                    <div class="preview-stat-label">Total lignes</div>
                </div>
            </div>
            
            <div class="preview-table-container">
                <table class="preview-table" id="previewTable">
                    <thead id="previewTableHead">
                        <!-- G√©n√©r√© dynamiquement -->
                    </thead>
                    <tbody id="previewTableBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 15px;">
                <div>
                    <button class="btn btn-warning" onclick="fixAllErrors()">üîß Corriger automatiquement</button>
                    <button class="btn btn-danger" onclick="removeErrorRows()">üóëÔ∏è Supprimer lignes en erreur</button>
                </div>
                <div>
                    <button class="btn btn-success" onclick="importPreviewedData()">‚úÖ Importer les donn√©es</button>
                    <button class="btn btn-primary" onclick="importIgnoreErrors()">‚ö†Ô∏è Importer en ignorant les erreurs</button>
                    <button class="btn btn-danger" onclick="closePreview()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CR√âDIT PRODUCTEUR -->
    <div class="producer-credit">
        üè¢ D√©velopp√© par Mathis Corp. - SNCF Connect
    </div>

    <script>
        // üîß CONFIGURATION GLOBALE COMPL√àTE
        const tabConfigs = {
            creation: {
                columns: ['GA', 'Date Demande', 'Date Traitement', 'RG', 'Nom de RG', 'Num√©ro de Bail', 'UT-BAT', 'Commentaires'],
                displayName: 'Cr√©ation',
                icon: 'üìù'
            },
            modification: {
                columns: ['GA', 'Date Demande', 'Date Traitement', 'UT-BAT', 'RG', 'Nom de RG', 'Num√©ro de Bail', 'Commentaires'],
                displayName: 'Modification RG',
                icon: 'üîÑ'
            },
            resiliation: {
                columns: ['GA', 'Date Demande', 'Date Traitement', 'Num√©ro de Bail', 'UT-BAT', 'Commentaires'],
                displayName: 'R√©siliation',
                icon: '‚ùå'
            },
            autremodif: {
                columns: ['GA', 'Date Demande', 'Date Traitement', 'Num√©ro de Bail', 'UT-BAT', 'Type Modification', 'Commentaires'],
                displayName: 'Autre modification',
                icon: 'üîß'
            },
            modifsurface: {
                columns: ['GA', 'Date Demande', 'Date Traitement', 'Num√©ro de Bail', 'UT-BAT', '-', '+', 'Diff√©rence', 'Commentaires'],
                displayName: 'Modification surface',
                icon: 'üìê'
            },
            verifbaux: {
                columns: ['GA', 'UT-BAT', 'RG', 'Num√©ro Bail', '√âtat', 'Lieu', 'Nom du B√¢timent', 'R√©gion', 'Commentaire'],
                displayName: 'V√©rification baux',
                icon: '‚úÖ'
            },
            baserg: {
                columns: ['Code RG', 'Nom de RG', 'Utilisations', 'Derni√®re utilisation'],
                displayName: 'Base RG',
                icon: 'üóÇÔ∏è'
            }
        };

        // üéØ R√àGLES DE VALIDATION SNCF COMPL√àTES
        const validationRules = {
            'GA': {
                pattern: /^[A-Za-z]{2}$/,
                message: 'GA doit contenir exactement 2 lettres (initiales)',
                type: 'strict'
            },
            'Code RG': {
                pattern: /^\d+$/,
                message: 'Code RG doit contenir uniquement des chiffres',
                type: 'strict'
            },
            'RG': {
                pattern: /^\d+$/,
                message: 'RG doit contenir uniquement des chiffres',
                type: 'strict'
            },
         'Num√©ro Bail': {
                pattern: /^\d{6}$/,
                message: 'Num√©ro de bail doit contenir 6 chiffres',
                type: 'flexible'
            },
            '√âtat': {
                values: ['OK', 'NOK', 'EN COURS'],
                message: '√âtat doit √™tre OK, NOK ou EN COURS',
                type: 'strict'
            },
            '-': {
                pattern: /^\d+\.?\d*$/,
                message: 'Surface doit √™tre un nombre positif',
                type: 'flexible'
            },
            '+': {
                pattern: /^\d+\.?\d*$/,
                message: 'Surface doit √™tre un nombre positif',
                type: 'flexible'
            },
            'Type Modification': {
                values: ['Changement locataire', 'Modification bail', 'Avenant', 'Renouvellement', 'Autre'],
                message: 'Type de modification non reconnu',
                type: 'flexible'
            }
        };

        // Variables globales
        let rowCounters = {};
        let rgDatabase = {};
        let columnSuggestions = {};
        let currentPreviewData = null;
        let currentTabForPreview = null;
        let searchResults = [];
        let pendingTasks = [];
        let taskDrafts = [];
        let completedTasks = [];
        let savedSearches = [];
        let autoSaveInterval = null;
        let chartInstances = {};
        let activityLog = [];
        let audioContext = null;

        // Initialisation des compteurs
        Object.keys(tabConfigs).forEach(tabName => {
            rowCounters[tabName] = 0;
        });

        // üéµ AUDIO DOUX POUR LES ACTIONS
        function getAudioContext() {
            if (!window.AudioContext && !window.webkitAudioContext) return null;

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            return audioContext;
        }

        function playLofiTone(type = 'info') {
            const ctx = getAudioContext();
            if (!ctx) return;

            const now = ctx.currentTime;
            const gain = ctx.createGain();
            const filter = ctx.createBiquadFilter();

            const palettes = {
                success: [
                    { base: 520, interval: 6, wave: 'sine' },
                    { base: 480, interval: 9, wave: 'sine' }
                ],
                error: [
                    { base: 210, interval: -5, wave: 'sine' },
                    { base: 240, interval: -7, wave: 'triangle' }
                ],
                warning: [
                    { base: 340, interval: 3, wave: 'sine' },
                    { base: 380, interval: 2, wave: 'triangle' }
                ],
                info: [
                    { base: 410, interval: 5, wave: 'sine' },
                    { base: 440, interval: 7, wave: 'triangle' }
                ],
                click: [
                    { base: 280, interval: 4, wave: 'sine' },
                    { base: 320, interval: 5, wave: 'triangle' }
                ]
            };

            const palette = palettes[type] || palettes.info;
            const choice = palette[Math.floor(Math.random() * palette.length)];
            const harmonicFreq = choice.base * Math.pow(2, choice.interval / 12);

            const createOsc = (freq, detune = 0) => {
                const osc = ctx.createOscillator();
                osc.type = choice.wave;
                osc.frequency.setValueAtTime(freq + detune, now);
                return osc;
            };

            const oscA = createOsc(choice.base, Math.random() * 6 - 3);
            const oscB = createOsc(harmonicFreq, Math.random() * 4 - 2);

            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(950, now);

            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.exponentialRampToValueAtTime(0.04, now + 0.06);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);

            oscA.connect(filter);
            oscB.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);

            oscA.start(now);
            oscB.start(now + 0.02);
            oscA.stop(now + 0.52);
            oscB.stop(now + 0.54);
        }

        function setupActionSounds() {
            document.addEventListener('click', event => {
                const target = event.target.closest('.btn, .tab, .file-drop-zone, .close-preview');
                if (target) {
                    playLofiTone('click');
                }
            });
        }

        // üîß FONCTIONS UTILITAIRES COMPL√àTES
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 16px;">${getNotificationIcon(type)}</div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(notification);

            playLofiTone(type);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);

            // Log de l'activit√©
            logActivity(message, type);
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            return icons[type] || '‚ÑπÔ∏è';
        }

        function logActivity(message, type) {
            activityLog.unshift({
                timestamp: new Date(),
                message: message,
                type: type
            });
            
            // Garder seulement les 50 derni√®res activit√©s
            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }
            
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            if (activityLog.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Aucune activit√© r√©cente</div>';
                return;
            }
            
            const html = activityLog.slice(0, 5).map(activity => {
                const timeStr = activity.timestamp.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const icon = getNotificationIcon(activity.type);
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;">
                        <div style="font-size: 14px;">${icon}</div>
                        <div style="flex: 1;">${activity.message}</div>
                        <div style="color: #666; font-size: 11px;">${timeStr}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function showSaveStatus(message, type = 'success') {
            const status = document.getElementById('saveStatus');
            if (status) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                status.textContent = `${message} - ${timeStr}`;
                status.style.color = type === 'error' ? '#dc3545' : '#28a745';
            }
        }

        function generateUniqueId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getTabDisplayName(tabName) {
            return tabConfigs[tabName]?.displayName || tabName;
        }

        function getTabIcon(tabName) {
            return tabConfigs[tabName]?.icon || 'üìÑ';
        }

        // üîß GESTION DES ONGLETS
        function switchTab(tabName) {
            try {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetContent = document.getElementById(tabName);
                const targetTab = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                
                if (targetContent) targetContent.classList.add('active');
                if (targetTab) targetTab.classList.add('active');

                // Actions sp√©cifiques par onglet
                if (tabName === 'statistiques') {
                    updateStatsDashboard();
                } else if (tabName === 'baserg') {
                    updateRGUsageStats();
                } else if (tabName === 'taches') {
                    updateTasksStats();
                } else if (tabName !== 'recherche') {
                    updateStats(tabName);
                }

                logActivity(`Navigation vers ${getTabDisplayName(tabName)}`, 'info');
                
            } catch (error) {
                console.error('Erreur changement onglet:', error);
                showNotification('‚ùå Erreur lors du changement d\'onglet', 'error');
            }
        }

        // üöÄ SYST√àME IMPORT FICHIER CORRIG√â
        function triggerFileInput(tabName) {
            const fileInput = document.getElementById(`fileInput${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (fileInput) {
                // Supprimer les anciens event listeners pour √©viter les doublons
                fileInput.onclick = null;
                fileInput.click();
            }
        }

        function handleFileImport(tabName, input) {
            const file = input.files[0];
            if (!file) return;

            if (!window.XLSX) {
                showNotification('‚ùå Biblioth√®que Excel non charg√©e', 'error');
                return;
            }

            showNotification(`üì• Analyse du fichier "${file.name}" en cours...`, 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let workbook;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        const csvData = e.target.result;
                        workbook = XLSX.read(csvData, { type: 'string' });
                    } else {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array' });
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        showNotification(`‚ùå Le fichier "${file.name}" semble vide`, 'error');
                        return;
                    }
                    
                    currentPreviewData = processImportData(jsonData, tabName);
                    currentTabForPreview = tabName;
                    
                    showPreview(tabName);
                    showNotification(`‚úÖ Fichier "${file.name}" analys√© avec succ√®s`, 'success');
                    
                } catch (error) {
                    console.error('Erreur lecture fichier:', error);
                    showNotification(`‚ùå Erreur lors de la lecture du fichier "${file.name}"`, 'error');
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
            
            input.value = '';
        }

        // üìã SYST√àME COPIER-COLLER
        function togglePasteArea(tabName) {
            const pasteArea = document.getElementById(`pasteArea${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (pasteArea) {
                pasteArea.classList.toggle('active');
                if (pasteArea.classList.contains('active')) {
                    const textarea = pasteArea.querySelector('textarea');
                    if (textarea) {
                        textarea.focus();
                        textarea.value = '';
                    }
                }
            }
        }

        function analyzePastedData(tabName) {
            const textarea = document.getElementById(`pasteTextarea${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (!textarea || !textarea.value.trim()) {
                showNotification('‚ùå Aucune donn√©e √† analyser', 'error');
                return;
            }

            try {
                showNotification('üîç Analyse des donn√©es coll√©es...', 'info');
                
                const rawData = textarea.value.trim();
                const lines = rawData.split('\n');
                const parsedData = lines.map(line => {
                    return line.split(/\t|;|,/).map(cell => cell.trim().replace(/"/g, ''));
                });
                
                if (parsedData.length === 0) {
                    showNotification('‚ùå Aucune donn√©e valide trouv√©e', 'error');
                    return;
                }
                
                currentPreviewData = processImportData(parsedData, tabName);
                currentTabForPreview = tabName;
                
                togglePasteArea(tabName);
                showPreview(tabName);
                showNotification(`‚úÖ ${parsedData.length} ligne(s) analys√©e(s)`, 'success');
                
            } catch (error) {
                console.error('Erreur analyse donn√©es coll√©es:', error);
                showNotification('‚ùå Erreur lors de l\'analyse des donn√©es', 'error');
            }
        }

        // üîç TRAITEMENT ET VALIDATION DES DONN√âES
        function processImportData(rawData, tabName) {
            try {
                const expectedColumns = tabConfigs[tabName]?.columns || [];
                const processedData = {
                    headers: [],
                    rows: [],
                    validationResults: {
                        valid: 0,
                        errors: 0,
                        warnings: 0,
                        total: 0
                    }
                };
                
                if (rawData.length === 0) return processedData;
                
                // D√©tecter les en-t√™tes
                const firstRow = rawData[0];
                const hasHeaders = detectHeaders(firstRow, expectedColumns);
                
                let dataStartIndex = hasHeaders ? 1 : 0;
                processedData.headers = hasHeaders ? firstRow : expectedColumns.slice(0, firstRow.length);
                
                // Traiter chaque ligne
                for (let i = dataStartIndex; i < rawData.length; i++) {
                    const rawRow = rawData[i];
                    if (!rawRow || rawRow.every(cell => !cell || cell.toString().trim() === '')) {
                        continue;
                    }
                    
                    const processedRow = {
                        data: [],
                        validations: [],
                        hasErrors: false,
                        hasWarnings: false
                    };
                    
                    for (let j = 0; j < Math.max(rawRow.length, expectedColumns.length); j++) {
                        const cellValue = j < rawRow.length ? rawRow[j] : '';
                        const columnName = j < processedData.headers.length ? processedData.headers[j] : '';
                        const expectedColumn = j < expectedColumns.length ? expectedColumns[j] : '';
                        
                        let cleanValue = cleanCellValue(cellValue, expectedColumn || columnName);
                        const validation = validateCell(cleanValue, expectedColumn || columnName, tabName);
                        
                        processedRow.data.push(cleanValue);
                        processedRow.validations.push(validation);
                        
                        if (validation.status === 'error') {
                            processedRow.hasErrors = true;
                            processedData.validationResults.errors++;
                        } else if (validation.status === 'warning') {
                            processedRow.hasWarnings = true;
                            processedData.validationResults.warnings++;
                        } else if (validation.status === 'valid') {
                            processedData.validationResults.valid++;
                        }
                    }
                    
                    processedData.rows.push(processedRow);
                }
                
                processedData.validationResults.total = processedData.rows.length;
                
                return processedData;
                
            } catch (error) {
                console.error('Erreur traitement donn√©es:', error);
                showNotification('‚ùå Erreur lors du traitement des donn√©es', 'error');
                return {
                    headers: [],
                    rows: [],
                    validationResults: { valid: 0, errors: 0, warnings: 0, total: 0 }
                };
            }
        }

        function detectHeaders(firstRow, expectedColumns) {
            if (!firstRow || firstRow.length === 0) return false;
            
            const matchScore = firstRow.reduce((score, cell, index) => {
                const cellStr = cell.toString().toLowerCase();
                const expectedStr = expectedColumns[index] ? expectedColumns[index].toLowerCase() : '';
                
                if (cellStr.includes('ga') || cellStr.includes('date') || 
                    cellStr.includes('rg') || cellStr.includes('bail') ||
                    cellStr.includes('surface') || cellStr.includes('√©tat') ||
                    cellStr.includes('commentaire') || cellStr.includes('nom')) {
                    return score + 1;
                }
                
                return score;
            }, 0);
            
            return matchScore >= Math.min(2, firstRow.length * 0.3);
        }

        function cleanCellValue(value, columnName) {
            if (!value && value !== 0) return '';
            
            let cleanValue = value.toString().trim();
            
            if (columnName && (columnName.toLowerCase().includes('date'))) {
                if (typeof value === 'number' && value > 40000 && value < 50000) {
                    // Date Excel
                    const excelDate = new Date((value - 25569) * 86400 * 1000);
                    cleanValue = excelDate.toISOString().split('T')[0];
                } else if (typeof value === 'string') {
                    const dateFormats = [
                        /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                        /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
                        /^(\d{1,2})-(\d{1,2})-(\d{4})$/
                    ];
                    
                    for (let format of dateFormats) {
                        const match = cleanValue.match(format);
                        if (match) {
                            if (format.source.startsWith('^(\\d{4})')) {
                                cleanValue = `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`;
                            } else {
                                cleanValue = `${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`;
                            }
                            break;
                        }
                    }
                }
            } else if (columnName && (columnName.toLowerCase().includes('surface'))) {
                cleanValue = cleanValue.replace(',', '.');
            } else if (columnName && (columnName.toLowerCase().includes('ga'))) {
                cleanValue = cleanValue.toUpperCase();
            } else if (columnName && (columnName.toLowerCase().includes('√©tat') || columnName.toLowerCase().includes('etat'))) {
                cleanValue = cleanValue.toUpperCase();
                if (cleanValue === 'ENCOURS' || cleanValue === 'EN_COURS') {
                    cleanValue = 'EN COURS';
                }
            }
            
            return cleanValue;
        }

        function validateCell(value, columnName, tabName) {
            const validation = {
                status: 'valid',
                message: '',
                originalValue: value
            };
            
            if (!columnName || !value) return validation;
            
            const rule = validationRules[columnName];
            if (rule) {
                if (rule.pattern && value) {
                    if (!rule.pattern.test(value)) {
                        validation.status = rule.type === 'flexible' ? 'warning' : 'error';
                        validation.message = rule.message;
                    }
                } else if (rule.values && value) {
                    if (!rule.values.includes(value)) {
                        validation.status = rule.type === 'flexible' ? 'warning' : 'error';
                        validation.message = rule.message;
                    }
                }
            }
            
            // Validations sp√©cifiques
            if (columnName.toLowerCase().includes('date') && value) {
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!dateRegex.test(value)) {
                    validation.status = 'warning';
                    validation.message = 'Format de date non standard';
                } else {
                    const date = new Date(value);
                    const now = new Date();
                    if (date > now) {
                        validation.status = 'warning';
                        validation.message = 'Date dans le futur';
                    }
                }
            }
            
            // V√©rification base RG
            if ((columnName === 'RG' || columnName === 'Code RG') && value && Object.keys(rgDatabase).length > 0) {
                if (!rgDatabase[value]) {
                    validation.status = 'warning';
                    validation.message = 'Code RG non trouv√© dans la base';
                }
            }
            
            return validation;
        }

        // üîç FEN√äTRE DE PR√âVISUALISATION
        function showPreview(tabName) {
            try {
                if (!currentPreviewData) return;
                
                const modal = document.getElementById('previewModal');
                const title = document.getElementById('previewTitle');
                const tableHead = document.getElementById('previewTableHead');
                const tableBody = document.getElementById('previewTableBody');
                
                title.textContent = `üîç Pr√©visualisation - ${getTabDisplayName(tabName)}`;
                
                const results = currentPreviewData.validationResults;
                document.getElementById('previewValidCount').textContent = results.valid;
                document.getElementById('previewErrorCount').textContent = results.errors;
                document.getElementById('previewWarningCount').textContent = results.warnings;
                document.getElementById('previewTotalCount').textContent = results.total;
                
                // En-t√™te
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th style="width: 40px;">#</th>';
                
                currentPreviewData.headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.style.minWidth = '120px';
                    headerRow.appendChild(th);
                });
                
                headerRow.innerHTML += '<th style="width: 80px;">Statut</th>';
                tableHead.appendChild(headerRow);
                
                // Corps du tableau
                tableBody.innerHTML = '';
                currentPreviewData.rows.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    
                    const numberCell = document.createElement('td');
                    numberCell.textContent = rowIndex + 1;
                    numberCell.className = 'row-number';
                    tr.appendChild(numberCell);
                    
                    row.data.forEach((cellValue, cellIndex) => {
                        const td = document.createElement('td');
                        td.className = 'editable-cell';
                        td.setAttribute('data-row', rowIndex);
                        td.setAttribute('data-col', cellIndex);
                        td.textContent = cellValue;
                        
                        const validation = row.validations[cellIndex];
                        if (validation && validation.status !== 'valid') {
                            const indicator = document.createElement('div');
                            indicator.className = `validation-indicator ${validation.status}`;
                            indicator.title = validation.message;
                            td.appendChild(indicator);
                        }
                        
                        td.addEventListener('click', () => makeEditable(td, rowIndex, cellIndex));
                        tr.appendChild(td);
                    });
                    
                    const statusCell = document.createElement('td');
                    if (row.hasErrors) {
                        statusCell.innerHTML = '<span style="color: #dc3545;">‚ùå</span>';
                        statusCell.title = 'Erreurs d√©tect√©es';
                    } else if (row.hasWarnings) {
                        statusCell.innerHTML = '<span style="color: #ffc107;">‚ö†Ô∏è</span>';
                        statusCell.title = 'Avertissements';
                    } else {
                        statusCell.innerHTML = '<span style="color: #28a745;">‚úÖ</span>';
                        statusCell.title = 'Donn√©es valides';
                    }
                    tr.appendChild(statusCell);
                    
                    tableBody.appendChild(tr);
                });
                
                modal.classList.add('show');
                
            } catch (error) {
                console.error('Erreur affichage pr√©visualisation:', error);
                showNotification('‚ùå Erreur lors de l\'affichage de la pr√©visualisation', 'error');
            }
        }

        function makeEditable(cell, rowIndex, colIndex) {
            if (cell.classList.contains('editing')) return;
            
            const currentValue = cell.textContent;
            cell.classList.add('editing');
            
            const input = document.createElement('textarea');
            input.value = currentValue;
            input.className = 'editable editable-textarea';
            input.rows = 1;
            autoResizeField(input);

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            function finishEditing() {
                const newValue = input.value;
                cell.classList.remove('editing');
                cell.textContent = newValue;
                
                if (currentPreviewData && currentPreviewData.rows[rowIndex]) {
                    const columnName = currentPreviewData.headers[colIndex];
                    const cleanValue = cleanCellValue(newValue, columnName);
                    const validation = validateCell(cleanValue, columnName, currentTabForPreview);
                    
                    currentPreviewData.rows[rowIndex].data[colIndex] = cleanValue;
                    currentPreviewData.rows[rowIndex].validations[colIndex] = validation;
                    
                    cell.innerHTML = '';
                    cell.textContent = cleanValue;
                    
                    if (validation.status !== 'valid') {
                        const indicator = document.createElement('div');
                        indicator.className = `validation-indicator ${validation.status}`;
                        indicator.title = validation.message;
                        cell.appendChild(indicator);
                    }
                    
                    updatePreviewStats();
                }
            }
            
            input.addEventListener('blur', finishEditing);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEditing();
                } else if (e.key === 'Escape') {
                    cell.classList.remove('editing');
                    cell.textContent = currentValue;
                }
            });
        }

        function updatePreviewStats() {
            try {
                if (!currentPreviewData) return;
                
                let valid = 0, errors = 0, warnings = 0;
                
                currentPreviewData.rows.forEach(row => {
                    row.hasErrors = false;
                    row.hasWarnings = false;
                    
                    row.validations.forEach(validation => {
                        if (validation.status === 'error') {
                            errors++;
                            row.hasErrors = true;
                        } else if (validation.status === 'warning') {
                            warnings++;
                            row.hasWarnings = true;
                        } else if (validation.status === 'valid') {
                            valid++;
                        }
                    });
                });
                
                currentPreviewData.validationResults = {
                    valid: valid,
                    errors: errors,
                    warnings: warnings,
                    total: currentPreviewData.rows.length
                };
                
                document.getElementById('previewValidCount').textContent = valid;
                document.getElementById('previewErrorCount').textContent = errors;
                document.getElementById('previewWarningCount').textContent = warnings;
                document.getElementById('previewTotalCount').textContent = currentPreviewData.rows.length;
                
            } catch (error) {
                console.error('Erreur mise √† jour stats pr√©visualisation:', error);
            }
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('show');
            currentPreviewData = null;
            currentTabForPreview = null;
        }

        // üîß ACTIONS DE PR√âVISUALISATION
        function fixAllErrors() {
            try {
                if (!currentPreviewData) return;
                
                let fixed = 0;
                
                currentPreviewData.rows.forEach((row, rowIndex) => {
                    row.data.forEach((cellValue, colIndex) => {
                        const validation = row.validations[colIndex];
                        const columnName = currentPreviewData.headers[colIndex];
                        
                        if (validation.status === 'error' || validation.status === 'warning') {
                            let fixedValue = cellValue;
                            
                            if (columnName === 'GA' && cellValue.length !== 2) {
                                if (cellValue.length > 2) {
                                    fixedValue = cellValue.substring(0, 2).toUpperCase();
                                } else if (cellValue.length === 1) {
                                    fixedValue = cellValue.toUpperCase() + 'X';
                                }
                            } else if (columnName.includes('RG') && !/^\d+$/.test(cellValue) && cellValue) {
                                fixedValue = cellValue.replace(/\D/g, '');
                            } else if (columnName.includes('Num√©ro') && columnName.includes('Bail')) {
                                fixedValue = cellValue.replace(/\D/g, '').padStart(6, '0').substring(0, 6);
                            } else if (columnName === '√âtat' || columnName === 'Etat') {
                                const upperValue = cellValue.toUpperCase();
                                if (upperValue.includes('OK') && !upperValue.includes('NOK')) {
                                    fixedValue = 'OK';
                                } else if (upperValue.includes('NOK')) {
                                    fixedValue = 'NOK';
                                } else if (upperValue.includes('COURS') || upperValue.includes('PROGRESS')) {
                                    fixedValue = 'EN COURS';
                                }
                            }
                            
                            if (fixedValue !== cellValue) {
                                currentPreviewData.rows[rowIndex].data[colIndex] = fixedValue;
                                const newValidation = validateCell(fixedValue, columnName, currentTabForPreview);
                                currentPreviewData.rows[rowIndex].validations[colIndex] = newValidation;
                                fixed++;
                            }
                        }
                    });
                });
                
                if (fixed > 0) {
                    showNotification(`üîß ${fixed} cellule(s) corrig√©e(s) automatiquement`);
                    showPreview(currentTabForPreview);
                } else {
                    showNotification('‚ÑπÔ∏è Aucune correction automatique possible', 'warning');
                }
                
            } catch (error) {
                console.error('Erreur correction automatique:', error);
                showNotification('‚ùå Erreur lors de la correction automatique', 'error');
            }
        }

        function removeErrorRows() {
            try {
                if (!currentPreviewData) return;
                
                const initialCount = currentPreviewData.rows.length;
                currentPreviewData.rows = currentPreviewData.rows.filter(row => !row.hasErrors);
                const finalCount = currentPreviewData.rows.length;
                const removed = initialCount - finalCount;
                
                if (removed > 0) {
                    showNotification(`üóëÔ∏è ${removed} ligne(s) en erreur supprim√©e(s)`);
                    updatePreviewStats();
                    showPreview(currentTabForPreview);
                } else {
                    showNotification('‚ÑπÔ∏è Aucune ligne en erreur √† supprimer', 'warning');
                }
                
            } catch (error) {
                console.error('Erreur suppression lignes erreur:', error);
                showNotification('‚ùå Erreur lors de la suppression', 'error');
            }
        }

        function importPreviewedData() {
            try {
                if (!currentPreviewData || !currentTabForPreview) return;
                
                const errorCount = currentPreviewData.validationResults.errors;
                if (errorCount > 0) {
                    if (!confirm(`‚ö†Ô∏è Il y a encore ${errorCount} erreur(s). Voulez-vous vraiment importer ?`)) {
                        return;
                    }
                }
                
                importDataToTable(currentPreviewData, currentTabForPreview);
                
            } catch (error) {
                console.error('Erreur import donn√©es pr√©visualis√©es:', error);
                showNotification('‚ùå Erreur lors de l\'import', 'error');
            }
        }

        function importIgnoreErrors() {
            try {
                if (!currentPreviewData || !currentTabForPreview)
return;
                
                const errorCount = currentPreviewData.validationResults.errors;
                if (errorCount > 0) {
                    if (!confirm(`‚ö†Ô∏è ${errorCount} erreur(s) seront ignor√©es. Continuer ?`)) {
                        return;
                    }
                }
                
                importDataToTable(currentPreviewData, currentTabForPreview);
                
            } catch (error) {
                console.error('Erreur import avec erreurs ignor√©es:', error);
                showNotification('‚ùå Erreur lors de l\'import', 'error');
            }
        }

        function importDataToTable(previewData, tabName) {
            try {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) {
                    showNotification('‚ùå Tableau cible non trouv√©', 'error');
                    return;
                }
                
                let imported = 0;
                
                previewData.rows.forEach(row => {
                    if (row.data.some(cell => cell && cell.toString().trim())) {
                        addRowWithData(tabName, row.data);
                        imported++;
                    }
                });
                
                updateStats(tabName);
                saveAllData();
                closePreview();
                
                showNotification(`‚úÖ ${imported} ligne(s) import√©e(s) avec succ√®s`);
                logActivity(`Import de ${imported} lignes dans ${getTabDisplayName(tabName)}`, 'success');
                
            } catch (error) {
                console.error('Erreur import vers tableau:', error);
                showNotification('‚ùå Erreur lors de l\'import vers le tableau', 'error');
            }
        }

        // üìä GESTION DES TABLEAUX
        function autoResizeField(field) {
            if (field.tagName === 'TEXTAREA') {
                field.style.height = 'auto';
                field.style.height = Math.max(field.scrollHeight, 38) + 'px';
            }
        }

        function createEditableField(column, tabName, value = '') {
            const inputType = getInputType(column);
            const field = inputType === 'text' ? document.createElement('textarea') : document.createElement('input');

            field.className = inputType === 'text' ? 'editable editable-textarea' : 'editable';
            field.placeholder = `Saisir ${column.toLowerCase()}...`;
            field.value = value;

            if (field.tagName === 'INPUT') {
                field.type = inputType;
            }

            if (field.tagName === 'TEXTAREA') {
                field.rows = 1;
                autoResizeField(field);
            }

            return field;
        }

        function addRow(tabName) {
            try {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;

                const columns = tabConfigs[tabName]?.columns || [];
                const rowNum = ++rowCounters[tabName];

                const row = document.createElement('tr');

                const numberCell = document.createElement('td');
                numberCell.className = 'row-number';
                numberCell.textContent = rowNum;
                row.appendChild(numberCell);

                columns.forEach((column, index) => {
                    const cell = document.createElement('td');
                    const input = createEditableField(column, tabName);

                    // √âv√©nements sp√©ciaux
                    if (tabName === 'modifsurface' && (column === '-' || column === '+')) {
                        input.addEventListener('input', () => calculateSurfaceDifference(row));
                    }

                    if (tabName === 'baserg' && column === 'Code RG') {
                        input.addEventListener('input', () => updateRGDatabase());
                    } else if (tabName === 'baserg' && column === 'Nom de RG') {
                        input.addEventListener('input', () => updateRGDatabase());
                    } else if (tabName === 'baserg' && (column === 'Utilisations' || column === 'Derni√®re utilisation')) {
                        input.readOnly = true;
                        input.value = column === 'Utilisations' ? '0' : '';
                        input.style.backgroundColor = '#f8f9fa';
                    }

                    if (column === 'RG' || column === 'Code RG') {
                        setupRGAutoCompletion(input, row, tabName);
                    } else if (column === 'Nom de RG') {
                        setupNomRGAutoCompletion(input, row, tabName);
                    }

                    attachColumnAutocomplete(input, column);

                    attachColumnAutocomplete(input, column);

                    input.addEventListener('input', () => {
                        autoResizeField(input);
                        validateInputInRealTime(input, column, tabName);
                        saveAllData();
                        updateStats(tabName);
                    });

                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteRow(row, tabName);
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);

                tbody.appendChild(row);

                const firstInput = row.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }

                updateStats(tabName);
                if (tabName === 'baserg') {
                    updateRGDatabase();
                }
                logActivity(`Nouvelle ligne ajout√©e dans ${getTabDisplayName(tabName)}`, 'info');
                
            } catch (error) {
                console.error('Erreur ajout ligne:', error);
                showNotification('‚ùå Erreur lors de l\'ajout de ligne', 'error');
            }
        }

        function addRowWithData(tabName, data) {
            try {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;
                
                const columns = tabConfigs[tabName]?.columns || [];
                const rowNum = ++rowCounters[tabName];
                
                const row = document.createElement('tr');
                
                const numberCell = document.createElement('td');
                numberCell.className = 'row-number';
                numberCell.textContent = rowNum;
                row.appendChild(numberCell);
                
                columns.forEach((column, index) => {
                    const cell = document.createElement('td');
                    const input = createEditableField(column, tabName, data[index] || '');

                    // Calculs sp√©cifiques
                    if (tabName === 'modifsurface' && column === 'Diff√©rence') {
                        const surfaceAvant = parseFloat(data[columns.indexOf('-')] || 0);
                        const surfaceApres = parseFloat(data[columns.indexOf('+')] || 0);
                        input.value = (surfaceApres - surfaceAvant).toFixed(2);
                        input.readOnly = true;
                        input.style.backgroundColor = '#f8f9fa';
                    }

                    if (tabName === 'baserg' && column === 'Code RG') {
                        input.addEventListener('input', () => updateRGDatabase());
                    } else if (tabName === 'baserg' && column === 'Nom de RG') {
                        input.addEventListener('input', () => updateRGDatabase());
                    } else if (tabName === 'baserg' && (column === 'Utilisations' || column === 'Derni√®re utilisation')) {
                        input.readOnly = true;
                        input.style.backgroundColor = '#f8f9fa';
                        if (column === 'Utilisations') {
                            input.value = data[index] || '0';
                        }
                    }
                    
                    // √âv√©nements
                    if (tabName === 'modifsurface' && (column === '-' || column === '+')) {
                        input.addEventListener('input', () => calculateSurfaceDifference(row));
                    }

                    if (column === 'RG' || column === 'Code RG') {
                        setupRGAutoCompletion(input, row, tabName);
                    } else if (column === 'Nom de RG') {
                        setupNomRGAutoCompletion(input, row, tabName);
                    }

                    attachColumnAutocomplete(input, column);

                    input.addEventListener('input', () => {
                        autoResizeField(input);
                        validateInputInRealTime(input, column, tabName);
                        saveAllData();
                        updateStats(tabName);
                    });
                    
                    // Validation initiale
                    validateInputInRealTime(input, column, tabName);
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteRow(row, tabName);
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);

                if (tabName === 'baserg') {
                    updateRGDatabase();
                }

            } catch (error) {
                console.error('Erreur ajout ligne avec donn√©es:', error);
                showNotification('‚ùå Erreur lors de l\'ajout de ligne avec donn√©es', 'error');
            }
        }

        function validateInputInRealTime(input, columnName, tabName) {
            try {
                const value = input.value;
                const validation = validateCell(value, columnName, tabName);
                
                input.classList.remove('has-error', 'has-warning');
                
                if (validation.status === 'error') {
                    input.classList.add('has-error');
                    input.title = validation.message;
                } else if (validation.status === 'warning') {
                    input.classList.add('has-warning');
                    input.title = validation.message;
                } else {
                    input.title = '';
                }
                
            } catch (error) {
                console.error('Erreur validation temps r√©el:', error);
            }
        }

        function deleteRow(row, tabName) {
            try {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ligne ?')) {
                    row.remove();
                    updateStats(tabName);
                    saveAllData();
                    showNotification('üóëÔ∏è Ligne supprim√©e');
                    logActivity(`Ligne supprim√©e dans ${getTabDisplayName(tabName)}`, 'warning');
                }
            } catch (error) {
                console.error('Erreur suppression ligne:', error);
                showNotification('‚ùå Erreur lors de la suppression', 'error');
            }
        }

        function getInputType(columnName) {
            const column = columnName.toLowerCase();
            if (column.includes('date')) return 'date';
            if (column.includes('surface') || column === '-' || column === '+') return 'number';
            return 'text';
        }

        function calculateSurfaceDifference(row) {
            try {
                const inputs = row.querySelectorAll('input, textarea');
                const columns = tabConfigs['modifsurface'].columns;
                
                const surfaceAvantIndex = columns.indexOf('-');
                const surfaceApresIndex = columns.indexOf('+');
                const differenceIndex = columns.indexOf('Diff√©rence');
                
                if (surfaceAvantIndex >= 0 && surfaceApresIndex >= 0 && differenceIndex >= 0) {
                    const surfaceAvantInput = inputs[surfaceAvantIndex];
                    const surfaceApresInput = inputs[surfaceApresIndex];
                    const differenceInput = inputs[differenceIndex];
                    
                    if (surfaceAvantInput && surfaceApresInput && differenceInput) {
                        const avant = parseFloat(surfaceAvantInput.value) || 0;
                        const apres = parseFloat(surfaceApresInput.value) || 0;
                        const difference = apres - avant;
                        differenceInput.value = difference.toFixed(2);
                        
                        // Colorer selon le signe
                        if (difference > 0) {
                            differenceInput.style.color = '#28a745';
                        } else if (difference < 0) {
                            differenceInput.style.color = '#dc3545';
                        } else {
                            differenceInput.style.color = '#666';
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur calcul diff√©rence surface:', error);
            }
        }

        function recalculateAllSurfaces() {
            try {
                const tbody = document.getElementById('modifsurfaceTableBody');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                let recalculated = 0;
                
                rows.forEach(row => {
                    calculateSurfaceDifference(row);
                    recalculated++;
                });
                
                if (recalculated > 0) {
                    showNotification(`üîÑ ${recalculated} diff√©rence(s) de surface recalcul√©e(s)`);
                    updateStats('modifsurface');
                    saveAllData();
                }
                
            } catch (error) {
                console.error('Erreur recalcul surfaces:', error);
                showNotification('‚ùå Erreur lors du recalcul des surfaces', 'error');
            }
        }

        // üìä STATISTIQUES COMPL√àTES
        function updateStats(tabName) {
            try {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const total = rows.length;
                let processed = 0;
                let pending = 0;
                
                if (tabName === 'verifbaux') {
                    let ok = 0, nok = 0, enCours = 0;
                    
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const etatIndex = tabConfigs[tabName].columns.indexOf('√âtat');
                        const etatInput = inputs[etatIndex];
                        const etat = etatInput ? etatInput.value.toUpperCase() : '';
                        
                        if (etat === 'OK') ok++;
                        else if (etat === 'NOK') nok++;
                        else if (etat === 'EN COURS') enCours++;
                    });
                    
                    document.getElementById(`${tabName}TotalRows`).textContent = total;
                    document.getElementById(`${tabName}OKRows`).textContent = ok;
                    document.getElementById(`${tabName}NOKRows`).textContent = nok;
                    document.getElementById(`${tabName}EnCoursRows`).textContent = enCours;
                    
                    const validationRate = total > 0 ? Math.round(((ok + nok) / total) * 100) : 0;
                    document.getElementById(`${tabName}ValidationRate`).textContent = validationRate + '%';
                    
                } else if (tabName === 'modifsurface') {
                    let totalDifference = 0;
                    
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const dateTraitementIndex = tabConfigs[tabName].columns.indexOf('Date Traitement');
                        const differenceIndex = tabConfigs[tabName].columns.indexOf('Diff√©rence');
                        
                        const dateTraitement = inputs[dateTraitementIndex] ? inputs[dateTraitementIndex].value : '';
                        const difference = inputs[differenceIndex] ? parseFloat(inputs[differenceIndex].value) || 0 : 0;
                        
                        if (dateTraitement) {
                            processed++;
                        } else {
                            pending++;
                        }
                        
                        totalDifference += difference;
                    });
                    
                    const completionRate = total > 0 ? Math.round((processed / total) * 100) : 0;
                    
                    document.getElementById(`${tabName}TotalRows`).textContent = total;
                    document.getElementById(`${tabName}ProcessedRows`).textContent = processed;
                    document.getElementById(`${tabName}PendingRows`).textContent = pending;
                    document.getElementById(`${tabName}TotalDifference`).textContent = totalDifference.toFixed(2) + ' m¬≤';
                    document.getElementById(`${tabName}CompletionRate`).textContent = completionRate + '%';
                    
                } else if (tabName === 'baserg') {
                    updateRGUsageStats();
                } else {
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const hasData = Array.from(inputs).some(input => input.value.trim() !== '');
                        
                        if (hasData) {
                            const dateTraitementIndex = tabConfigs[tabName].columns.indexOf('Date Traitement');
                            const dateTraitement = inputs[dateTraitementIndex] ? inputs[dateTraitementIndex].value : '';
                            
                            if (dateTraitement) {
                                processed++;
                            } else {
                                pending++;
                            }
                        }
                    });
                    
                    const completionRate = total > 0 ? Math.round((processed / total) * 100) : 0;
                    
                    const totalElement = document.getElementById(`${tabName}TotalRows`);
                    const processedElement = document.getElementById(`${tabName}ProcessedRows`);
                    const pendingElement = document.getElementById(`${tabName}PendingRows`);
                    const rateElement = document.getElementById(`${tabName}CompletionRate`);
                    
                    if (totalElement) totalElement.textContent = total;
                    if (processedElement) processedElement.textContent = processed;
                    if (pendingElement) pendingElement.textContent = pending;
                    if (rateElement) rateElement.textContent = completionRate + '%';
                }
                
            } catch (error) {
                console.error('Erreur mise √† jour statistiques:', error);
            }
        }

        function updateRGUsageStats() {
            try {
                const tbody = document.getElementById('basergTableBody');
                if (!tbody) return;

                const rows = tbody.querySelectorAll('tr');
                const total = rows.length;
                let used = 0;

                // Compter les utilisations et dates d'utilisation
                const usageCounts = {};
                const tabUsageDates = {};

                ['creation', 'modification', 'verifbaux'].forEach(tabName => {
                    const tabBody = document.getElementById(`${tabName}TableBody`);
                    if (!tabBody) return;

                    const tabRows = tabBody.querySelectorAll('tr');
                    tabRows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const rgIndex = tabConfigs[tabName].columns.indexOf('RG');
                        const dateIndex = tabConfigs[tabName].columns.indexOf('Date Traitement');

                        if (rgIndex >= 0 && inputs[rgIndex]) {
                            const rgValue = inputs[rgIndex].value.trim();
                            if (rgValue) {
                                usageCounts[rgValue] = (usageCounts[rgValue] || 0) + 1;

                                if (dateIndex >= 0 && inputs[dateIndex] && inputs[dateIndex].value) {
                                    const usageDate = reviveDate(inputs[dateIndex].value);
                                    if (usageDate && (!tabUsageDates[rgValue] || tabUsageDates[rgValue] < usageDate)) {
                                        tabUsageDates[rgValue] = usageDate;
                                    }
                                }
                            }
                        }
                    });
                });

                // Mettre √† jour l'affichage
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const codeRG = inputs[0] ? inputs[0].value : '';
                    const usageCount = usageCounts[codeRG] || 0;

                    if (usageCount > 0) {
                        used++;
                    }

                    if (inputs[2]) {
                        inputs[2].value = usageCount;
                        inputs[2].readOnly = true;
                        inputs[2].style.backgroundColor = '#f8f9fa';
                    }

                    if (inputs[3]) {
                        const lastUse = tabUsageDates[codeRG];
                        inputs[3].value = lastUse ? lastUse.toISOString().split('T')[0] : '';
                        inputs[3].readOnly = true;
                        inputs[3].style.backgroundColor = '#f8f9fa';
                    }
                });

                const usageRate = total > 0 ? Math.round((used / total) * 100) : 0;

                document.getElementById('basergTotalRows').textContent = total;
                document.getElementById('basergUsedRows').textContent = used;
                document.getElementById('basergUnusedRows').textContent = total - used;
                document.getElementById('basergUsageRate').textContent = usageRate + '%';

            } catch (error) {
                console.error('Erreur stats usage RG:', error);
            }
        }

        function getTabStatistics() {
            const perTab = [];
            let totalGeneral = 0;
            let traitesGeneral = 0;
            let attenteGeneral = 0;

            Object.keys(tabConfigs).forEach(tabName => {
                if (tabName === 'baserg') return;

                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;

                const rows = tbody.querySelectorAll('tr');
                const total = rows.length;
                let processed = 0;

                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const dateTraitementIndex = tabConfigs[tabName].columns.indexOf('Date Traitement');
                    const dateTraitement = inputs[dateTraitementIndex] ? inputs[dateTraitementIndex].value : '';

                    if (dateTraitement) {
                        processed++;
                    }
                });

                const pending = total - processed;
                const rate = total > 0 ? Math.round((processed / total) * 100) : 0;

                totalGeneral += total;
                traitesGeneral += processed;
                attenteGeneral += pending;

                perTab.push({ tabName, total, processed, pending, rate });
            });

            const tauxGeneral = totalGeneral > 0 ? Math.round((traitesGeneral / totalGeneral) * 100) : 0;

            return {
                general: {
                    total: totalGeneral,
                    traites: traitesGeneral,
                    attente: attenteGeneral,
                    taux: tauxGeneral
                },
                perTab
            };
        }

        function getRGChangeInsights() {
            try {
                const tbody = document.getElementById('modificationTableBody');
                const defaultInsights = { totalEntries: 0, utbatCount: 0, multiCount: 0, topChanges: [] };

                if (!tbody) return defaultInsights;

                const utbatIndex = tabConfigs['modification'].columns.indexOf('UT-BAT');
                const rgIndex = tabConfigs['modification'].columns.indexOf('RG');
                const rows = tbody.querySelectorAll('tr');
                const utbatMap = {};

                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const utbat = inputs[utbatIndex] ? inputs[utbatIndex].value.trim() : '';
                    const rgValue = inputs[rgIndex] ? inputs[rgIndex].value.trim() : '';

                    if (!utbat) return;

                    if (!utbatMap[utbat]) {
                        utbatMap[utbat] = { count: 0, rgs: new Set() };
                    }

                    utbatMap[utbat].count++;
                    if (rgValue) {
                        utbatMap[utbat].rgs.add(rgValue);
                    }
                });

                const multiChanges = Object.entries(utbatMap).filter(([, value]) => value.count > 1 || value.rgs.size > 1);
                const topChanges = multiChanges
                    .map(([utbat, value]) => ({
                        utbat,
                        occurrences: value.count,
                        variations: value.rgs.size
                    }))
                    .sort((a, b) => (b.occurrences - a.occurrences) || (b.variations - a.variations))
                    .slice(0, 5);

                return {
                    totalEntries: rows.length,
                    utbatCount: Object.keys(utbatMap).length,
                    multiCount: multiChanges.length,
                    topChanges
                };
            } catch (error) {
                console.error('Erreur calcul insights RG:', error);
                return { totalEntries: 0, utbatCount: 0, multiCount: 0, topChanges: [] };
            }
        }

        function updateRGChangeWidget(insights) {
            try {
                const data = insights || getRGChangeInsights();
                const utbatElement = document.getElementById('rgChangeUTBATCount');
                const multiElement = document.getElementById('rgChangeMultiCount');
                const moodElement = document.getElementById('rgChangeMood');
                const listContainer = document.getElementById('rgChangeDetails');

                if (utbatElement) utbatElement.textContent = data.utbatCount;
                if (multiElement) multiElement.textContent = data.multiCount;

                if (moodElement) {
                    if (data.multiCount === 0) {
                        moodElement.textContent = 'Tout est stable, aucun doublon d√©tect√© üéØ';
                    } else if (data.multiCount < 3) {
                        moodElement.textContent = 'Quelques UT-BAT n√©cessitent une double v√©rification üëÄ';
                    } else {
                        moodElement.textContent = 'Beaucoup de rotations RG sur les m√™mes UT-BAT ‚ö†Ô∏è';
                    }
                }

                if (!listContainer) return;

                listContainer.innerHTML = '';

                if (data.topChanges.length === 0) {
                    listContainer.innerHTML = '<div style="color: #666;">Aucun UT-BAT avec modifications r√©p√©t√©es pour le moment.</div>';
                    return;
                }

                data.topChanges.forEach(change => {
                    const item = document.createElement('div');
                    item.className = 'rg-change-item';
                    item.innerHTML = `
                        <div>
                            <strong>${change.utbat}</strong>
                            <div class="stat-chip-subtext">RG chang√©s plusieurs fois</div>
                        </div>
                        <div class="rg-change-meta">
                            <span>üîÅ ${change.occurrences} passages</span>
                            <span>üé≠ ${change.variations} RG distincts</span>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur mise √† jour suivi changements RG:', error);
            }
        }

        function updateStatChips(generalStats, rgInsights, qualityCounts) {
            try {
                const overallRateElement = document.getElementById('chipOverallRate');
                const overallSummaryElement = document.getElementById('chipOverallSummary');
                const rgMultiElement = document.getElementById('chipRgMultiCount');
                const rgDetailsElement = document.getElementById('chipRgDetails');
                const qualityAlertsElement = document.getElementById('chipQualityAlerts');
                const qualitySummaryElement = document.getElementById('chipQualitySummary');

                const rate = generalStats?.taux ?? 0;
                const total = generalStats?.total ?? 0;

                if (overallRateElement) {
                    overallRateElement.textContent = `${rate}%`;
                }

                if (overallSummaryElement) {
                    overallSummaryElement.textContent = total > 0
                        ? `${generalStats.traites} trait√©s sur ${total} entr√©es`
                        : 'Aucune donn√©e pour le moment';
                }

                if (rgMultiElement) {
                    rgMultiElement.textContent = rgInsights?.multiCount ?? 0;
                }

                if (rgDetailsElement) {
                    const utbatInfo = rgInsights?.utbatCount || 0;
                    const detailTop = rgInsights?.topChanges?.[0];
                    rgDetailsElement.textContent = rgInsights && rgInsights.multiCount > 0
                        ? `${detailTop?.utbat || 'UT-BAT'} surveill√© (${utbatInfo} UT-BAT touch√©s)`
                        : 'Aucun doublon d√©tect√©';
                }

                if (qualityAlertsElement) {
                    const alerts = (qualityCounts?.errors || 0) + (qualityCounts?.warnings || 0);
                    qualityAlertsElement.textContent = alerts;
                }

                if (qualitySummaryElement) {
                    if (!qualityCounts) {
                        qualitySummaryElement.textContent = 'Pas d\'alerte √† signaler';
                    } else {
                        const { errors = 0, warnings = 0 } = qualityCounts;
                        if (errors === 0 && warnings === 0) {
                            qualitySummaryElement.textContent = 'Pas d\'alerte √† signaler';
                        } else {
                            qualitySummaryElement.textContent = `${errors} erreur(s) / ${warnings} avertissement(s)`;
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur mise √† jour des pastilles ludiques:', error);
            }
        }

        function updateRGDatabase() {
            try {
                const tbody = document.getElementById('basergTableBody');
                if (!tbody) return;

                rgDatabase = {};
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const codeRG = inputs[0] ? inputs[0].value.trim() : '';
                    const nomRG = inputs[1] ? inputs[1].value.trim() : '';
                    
                    if (codeRG) {
                        rgDatabase[codeRG] = {
                            nom: nomRG,
                            utilisations: 0,
                            derniereUtilisation: null
                        };
                    }
                });

                updateRGUsageStats();
                refreshRGSuggestions();

            } catch (error) {
                console.error('Erreur mise √† jour base RG:', error);
            }
        }

        function ensureRGSuggestionLists() {
            let codeList = document.getElementById('rgDatalist');
            if (!codeList) {
                codeList = document.createElement('datalist');
                codeList.id = 'rgDatalist';
                document.body.appendChild(codeList);
            }

            let nameList = document.getElementById('rgNomDatalist');
            if (!nameList) {
                nameList = document.createElement('datalist');
                nameList.id = 'rgNomDatalist';
                document.body.appendChild(nameList);
            }
        }

        function refreshRGSuggestions() {
            ensureRGSuggestionLists();

            const codeList = document.getElementById('rgDatalist');
            const nameList = document.getElementById('rgNomDatalist');

            codeList.innerHTML = '';
            nameList.innerHTML = '';

            Object.entries(rgDatabase).forEach(([code, data]) => {
                const option = document.createElement('option');
                option.value = code;
                option.label = data.nom || '';
                codeList.appendChild(option);

                if (data.nom) {
                    const nameOption = document.createElement('option');
                    nameOption.value = data.nom;
                    nameOption.label = code;
                    nameList.appendChild(nameOption);
                }
            });
        }

        function findBestRGMatch(value) {
            const normalized = (value || '').trim();
            if (!normalized) return null;
            if (rgDatabase[normalized]) return normalized;
            return Object.keys(rgDatabase).find(code => code.startsWith(normalized)) || null;
        }

        function findBestRGNameMatch(value) {
            const normalized = (value || '').trim().toLowerCase();
            if (!normalized) return null;

            let match = Object.entries(rgDatabase).find(([, data]) => (data.nom || '').toLowerCase() === normalized);
            if (match) return match[0];

            match = Object.entries(rgDatabase).find(([, data]) => (data.nom || '').toLowerCase().startsWith(normalized));
            return match ? match[0] : null;
        }

        function getNomRGInput(row, tabName) {
            const columns = tabConfigs[tabName]?.columns || [];
            const nomIndex = columns.indexOf('Nom de RG');
            if (nomIndex < 0) return null;

            const inputs = row.querySelectorAll('input, textarea');
            return inputs[nomIndex] || null;
        }

        function getRGInput(row, tabName) {
            const columns = tabConfigs[tabName]?.columns || [];
            const rgIndex = columns.indexOf('RG');
            if (rgIndex < 0) return null;

            const inputs = row.querySelectorAll('input, textarea');
            return inputs[rgIndex] || null;
        }

        function autoFillNomFromRG(rgValue, row, tabName) {
            if (Object.keys(rgDatabase).length === 0) return;

            const match = findBestRGMatch(rgValue);
            if (!match) return;

            const nomInput = getNomRGInput(row, tabName);
            if (nomInput) {
                nomInput.value = rgDatabase[match]?.nom || '';
                nomInput.dataset.autoFilled = 'true';
                addColumnSuggestion('Nom de RG', nomInput.value);
            }
        }

        function autoFillRGFromName(nomValue, row, tabName) {
            if (Object.keys(rgDatabase).length === 0) return;

            const matchCode = findBestRGNameMatch(nomValue);
            if (!matchCode) return;

            const rgInput = getRGInput(row, tabName);
            if (rgInput) {
                rgInput.value = matchCode;
                rgInput.dataset.autoFilled = 'true';
                addColumnSuggestion(tabName === 'baserg' ? 'Code RG' : 'RG', rgInput.value);
            }
        }

        function setupRGAutoCompletion(input, row, tabName) {
            input.setAttribute('list', 'rgDatalist');

            const syncNom = () => autoFillNomFromRG(input.value, row, tabName);
            input.addEventListener('input', syncNom);
            input.addEventListener('change', syncNom);
        }

        function setupNomRGAutoCompletion(input, row, tabName) {
            input.setAttribute('list', 'rgNomDatalist');

            input.addEventListener('input', () => {
                input.dataset.autoFilled = 'false';
                autoFillRGFromName(input.value, row, tabName);
            });
        }

        function getColumnListId(column) {
            return `suggest-${column.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
        }

        function ensureColumnSuggestionList(column) {
            const listId = getColumnListId(column);
            let datalist = document.getElementById(listId);

            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = listId;
                document.body.appendChild(datalist);
            }

            return datalist;
        }

        function addColumnSuggestion(column, value) {
            if (!value || !column) return;

            const cleanedValue = value.trim();
            if (!cleanedValue) return;

            if (!columnSuggestions[column]) {
                columnSuggestions[column] = new Set();
            }

            const suggestions = columnSuggestions[column];
            if (suggestions.has(cleanedValue)) return;

            suggestions.add(cleanedValue);

            const datalist = ensureColumnSuggestionList(column);
            const option = document.createElement('option');
            option.value = cleanedValue;
            datalist.appendChild(option);
        }

        function refreshColumnSuggestionLists() {
            Object.entries(columnSuggestions).forEach(([column, values]) => {
                const datalist = ensureColumnSuggestionList(column);
                datalist.innerHTML = '';

                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalist.appendChild(option);
                });
            });
        }

        function rebuildColumnSuggestions() {
            columnSuggestions = {};

            Object.keys(tabConfigs).forEach(tabName => {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;

                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    inputs.forEach((input, index) => {
                        const column = tabConfigs[tabName]?.columns[index];

                        if (!column || column === 'RG' || column === 'Code RG' || column === 'Nom de RG') return;

                        addColumnSuggestion(column, input.value);
                    });
                });
            });

            refreshColumnSuggestionLists();
        }

        function attachColumnAutocomplete(input, column) {
            if (input.tagName !== 'INPUT') return;

            if (!column || column === 'RG' || column === 'Code RG' || column === 'Nom de RG') return;

            const datalistId = getColumnListId(column);
            ensureColumnSuggestionList(column);
            input.setAttribute('list', datalistId);

            if (input.value) {
                addColumnSuggestion(column, input.value);
            }

            input.addEventListener('input', () => addColumnSuggestion(column, input.value));
        }

        function buildRGDatabase() {
            try {
                updateRGDatabase();
                showNotification('üîÑ Index RG reconstruit avec succ√®s');
                logActivity('Reconstruction de l\'index RG', 'success');
            } catch (error) {
                console.error('Erreur reconstruction base RG:', error);
                showNotification('‚ùå Erreur lors de la reconstruction de l\'index RG', 'error');
            }
        }

        function updateStatsDashboard() {
            try {
                const statsData = getTabStatistics();
                const qualityCounts = getQualityCounts();
                const rgInsights = getRGChangeInsights();

                document.getElementById('totalGeneral').textContent = statsData.general.total;
                document.getElementById('traitesGeneral').textContent = statsData.general.traites;
                document.getElementById('attenteGeneral').textContent = statsData.general.attente;
                document.getElementById('tauxGeneral').textContent = statsData.general.taux + '%';
                document.getElementById('progressGeneral').style.width = statsData.general.taux + '%';

                updateIndividualStats(statsData.perTab);
                updateQualityStatus(qualityCounts);
                updateRGChangeWidget(rgInsights);
                updateStatChips(statsData.general, rgInsights, qualityCounts);
                updateCharts();

            } catch (error) {
                console.error('Erreur mise √† jour dashboard statistiques:', error);
            }
        }

        function updateIndividualStats(perTabStats) {
            try {
                const individualStatsContainer = document.getElementById('individualStats');
                if (!individualStatsContainer) return;

                individualStatsContainer.innerHTML = '';

                const statsToDisplay = perTabStats || getTabStatistics().perTab;

                statsToDisplay.forEach(stat => {
                    const rate = stat.total > 0 ? Math.round((stat.processed / stat.total) * 100) : 0;

                    const card = document.createElement('div');
                    card.className = 'stats-card';
                    card.innerHTML = `
                        <h3>${getTabIcon(stat.tabName)} ${getTabDisplayName(stat.tabName)}</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div class="preview-stat-number">${stat.total}</div>
                                <div class="preview-stat-label">Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="preview-stat-number success">${stat.processed}</div>
                                <div class="preview-stat-label">Trait√©s</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="preview-stat-number warning">${stat.pending}</div>
                                <div class="preview-stat-label">En attente</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${rate}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-weight: 600; color: #667eea;">
                            ${rate}% compl√©t√©
                        </div>
                    `;
                    
                    individualStatsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erreur mise √† jour statistiques individuelles:', error);
            }
        }

        function getQualityCounts() {
            const counts = { errors: 0, warnings: 0 };

            try {
                Object.keys(tabConfigs).forEach(tabName => {
                    if (tabName === 'baserg') return;

                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;

                    const rows = tbody.querySelectorAll('tr');

                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        inputs.forEach(input => {
                            if (input.classList.contains('has-error')) {
                                counts.errors++;
                            } else if (input.classList.contains('has-warning')) {
                                counts.warnings++;
                            }
                        });
                    });
                });
            } catch (error) {
                console.error('Erreur comptage qualit√©:', error);
            }

            return counts;
        }

        function updateQualityStatus(counts) {
            try {
                const container = document.getElementById('qualityStatus');
                if (!container) return;

                const { errors = 0, warnings = 0 } = counts || getQualityCounts();

                let status, icon, color;

                if (errors === 0 && warnings === 0) {
                    status = 'Vos donn√©es sont coh√©rentes !';
                    icon = '‚úÖ';
                    color = '#28a745';
                } else if (errors > 0) {
                    status = `${errors} erreur(s) d√©tect√©e(s)`;
                    icon = '‚ùå';
                    color = '#dc3545';
                } else {
                    status = `${warnings} avertissement(s)`;
                    icon = '‚ö†Ô∏è';
                    color = '#ffc107';
                }

                container.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">${icon}</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${color};">${status}</div>
                    <div style="color: #666; margin-top: 10px;">Derni√®re v√©rification: ${new Date().toLocaleTimeString('fr-FR')}</div>
                `;

            } catch (error) {
                console.error('Erreur mise √† jour qualit√©:', error);
            }
        }

        function updateCharts() {
            try {
                updateTabsChart();
                updateEvolutionChart();
                updateVerificationChart();
                updateSurfaceChart();
            } catch (error) {
                console.error('Erreur mise √† jour graphiques:', error);
            }
        }

        function updateTabsChart() {
            try {
                const ctx = document.getElementById('tabsChart');
                if (!ctx) return;
                
                const labels = [];
                const data = [];
                const backgroundColors = [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                ];
                
                Object.keys(tabConfigs).forEach((tabName, index) => {
                    if (tabName === 'baserg') return;
                    
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (tbody) {
                        const rowCount = tbody.querySelectorAll('tr').length;
                        if (rowCount > 0) {
                            labels.push(getTabDisplayName(tabName));
                            data.push(rowCount);
                        }
                    }
                });
                
                if (chartInstances.tabsChart) {
                    chartInstances.tabsChart.destroy();
                }
                
                if (data.length > 0 && window.Chart) {
                    chartInstances.tabsChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors.slice(0, data.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        boxWidth: 12,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erreur graphique r√©partition:', error);
            }
        }

        function updateEvolutionChart() {
            try {
                const ctx = document.getElementById('evolutionChart');
                if (!ctx || !window.Chart) return;
                
                // Simuler des donn√©es d'√©volution
                const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun'];
                const creationData = [12, 19, 8, 15, 25, 32];
                const modificationData = [8, 12, 15, 10, 18, 22];
                
                if (chartInstances.evolutionChart) {
                    chartInstances.evolutionChart.destroy();
                }
                
                chartInstances.evolutionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Cr√©ation',
                            data: creationData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Modification',
                            data: modificationData,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erreur graphique √©volution:', error);
            }
        }

        function updateVerificationChart() {
            try {
                const ctx = document.getElementById('verificationChart');
                if (!ctx || !window.Chart) return;
                
                const tbody = document.getElementById('verifbauxTableBody');
                if (!tbody) return;
                
                let ok = 0, nok = 0, enCours = 0;
                
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const etatIndex = tabConfigs['verifbaux'].columns.indexOf('√âtat');
                    const etatInput = inputs[etatIndex];
                    const etat = etatInput ? etatInput.value.toUpperCase() : '';
                    
                    if (etat === 'OK') ok++;
                    else if (etat === 'NOK') nok++;
                    else if (etat === 'EN COURS') enCours++;
                });
                
                if (chartInstances.verificationChart) {
                    chartInstances.verificationChart.destroy();
                }
                
                if (ok + nok + enCours > 0) {
                    chartInstances.verificationChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['OK', 'NOK', 'En cours'],
                            datasets: [{
                                data: [ok, nok, enCours],
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erreur graphique v√©rification:', error);
            }
        }

        function updateSurfaceChart() {
            try {
                const ctx = document.getElementById('surfaceChart');
                if (!ctx || !window.Chart) return;
                
                const tbody = document.getElementById('modifsurfaceTableBody');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const surfaceData = [];
                const labels = [];
                
                rows.forEach((row, index) => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const differenceIndex = tabConfigs['modifsurface'].columns.indexOf('Diff√©rence');
                    const difference = inputs[differenceIndex] ? parseFloat(inputs[differenceIndex].value) || 0 : 0;
                    
                    if (difference !== 0) {
                        surfaceData.push(difference);
                        labels.push(`Modification ${index + 1}`);
                    }
                });
                
                if (chartInstances.surfaceChart) {
                    chartInstances.surfaceChart.destroy();
                }
                
                if (surfaceData.length > 0) {
                    chartInstances.surfaceChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Diff√©rence de surface (m¬≤)',
                                data: surfaceData,
                                backgroundColor: surfaceData.map(val => val > 0 ? '#28a745' : '#dc3545'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erreur graphique surface:', error);
            }
        }

        // üîç SYST√àME DE FILTRAGE
        function filterTable(tabName) {
            try {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const filters = getFiltersForTab(tabName);
                
                rows.forEach(row => {
                    let showRow = true;
                    const inputs = row.querySelectorAll('input, textarea');
                    
                    Object.keys(filters).forEach(filterName => {
                        const filterValue = filters[filterName].toLowerCase();
                        if (!filterValue) return;
                        
                        const columnIndex = getColumnIndex(tabName, filterName);
                        if (columnIndex >= 0 && columnIndex < inputs.length) {
                            const cellValue = inputs[columnIndex].value.toLowerCase();
                            
                            if (filterName.includes('Date')) {
                                if (!filterDateRange(cellValue, filterValue, filterName)) {
                                    showRow = false;
                                }
                            } else if (filterName === 'Status') {
                                const hasDateTraitement = inputs[tabConfigs[tabName].columns.indexOf('Date Traitement')] && 
                                                         inputs[tabConfigs[tabName].columns.indexOf('Date Traitement')].value;
                                const isProcessed = hasDateTraitement ? 'traite' : 'attente';
                                if (filterValue !== isProcessed) {
                                    showRow = false;
                                }
                            } else {
                                if (!cellValue.includes(filterValue)) {
                                    showRow = false;
                                }
                            }
                        }
                    });
                    
                    row.style.display = showRow ? '' : 'none';
                });
                
            } catch (error) {
                console.error('Erreur filtrage tableau:', error);
            }
        }

        function getFiltersForTab(tabName) {
            const filters = {};
            const filterElements = document.querySelectorAll(`[id^="filter${tabName.charAt(0).toUpperCase() + tabName.slice(1)}"]`);
            
            filterElements.forEach(element => {
                const filterId = element.id;
                const filterName = filterId.replace(`filter${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`, '');
                filters[filterName] = element.value;
            });
            
            return filters;
        }

        function getColumnIndex(tabName, filterName) {
            const columns = tabConfigs[tabName]?.columns || [];
            const columnMap = {
                'GA': 'GA',
                'DateFrom': 'Date Demande',
                'DateTo': 'Date Demande',
                'RG': 'RG',
                'UTBAT': 'UT-BAT',
                'Status': 'Date Traitement',
                'Etat': '√âtat',
                'Region': 'R√©gion',
                'Type': 'Type Modification',
                'Code': 'Code RG',
                'Nom': 'Nom de RG',
                'Bail': 'Num√©ro de Bail',
                'Lieu': 'Lieu'
            };
            
            const columnName = columnMap[filterName];
            return columnName ? columns.indexOf(columnName) : -1;
        }

        function filterDateRange(cellValue, filterValue, filterType) {
            if (!cellValue || !filterValue) return true;
            
            const cellDate = new Date(cellValue);
            const filterDate = new Date(filterValue);
            
            if (filterType.includes('From')) {
                return cellDate >= filterDate;
            } else if (filterType.includes('To')) {
                return cellDate <= filterDate;
            }
            
            return true;
        }

        // üîç SYST√àME DE RECHERCHE AVANC√âE
        function performSearch() {
            try {
                const startTime = performance.now();
                
                const searchParams = {
                    ga: document.getElementById('searchGA').value.toLowerCase(),
                    rg: document.getElementById('searchRG').value.toLowerCase(),
                    utbat: document.getElementById('searchUTBAT').value.toLowerCase(),
                    bail: document.getElementById('searchBail').value.toLowerCase(),
                    advancedBail: (document.getElementById('advancedSearchBail')?.value || '').toLowerCase(),
                    dateFrom: document.getElementById('searchDateFrom').value,
                    dateTo: document.getElementById('searchDateTo').value,
                    tab: document.getElementById('searchTab').value,
                    keyword: document.getElementById('searchKeyword').value.toLowerCase()
                };
                
                searchResults = [];
                
                const tabsToSearch = searchParams.tab ? [searchParams.tab] : 
                    Object.keys(tabConfigs).filter(t => t !== 'baserg');
                
                tabsToSearch.forEach(tabName => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;
                    
                    const rows = tbody.querySelectorAll('tr');
                    const columns = tabConfigs[tabName]?.columns || [];
                    
                    rows.forEach((row, rowIndex) => {
                        const inputs = row.querySelectorAll('input, textarea');
                        let matchFound = false;
                        const rowData = [];
                        
                        inputs.forEach((input, inputIndex) => {
                            const value = input.value.toLowerCase();
                            rowData.push(input.value);
                            
                            if (searchParams.ga && columns[inputIndex] === 'GA' && value.includes(searchParams.ga)) matchFound = true;
                            if (searchParams.rg && (columns[inputIndex] === 'RG' || columns[inputIndex] === 'Code RG') && value.includes(searchParams.rg)) matchFound = true;
                            if (searchParams.utbat && columns[inputIndex] === 'UT-BAT' && value.includes(searchParams.utbat)) matchFound = true;
                            if (searchParams.bail && columns[inputIndex].includes('Bail') && value.includes(searchParams.bail)) matchFound = true;
                            if (searchParams.advancedBail && columns[inputIndex].includes('Bail') && value.includes(searchParams.advancedBail)) matchFound = true;
                            if (searchParams.keyword && value.includes(searchParams.keyword)) matchFound = true;
                            
                            if (searchParams.dateFrom || searchParams.dateTo) {
                                if (columns[inputIndex] && columns[inputIndex].includes('Date') && input.value) {
                                    const cellDate = new Date(input.value);
                                    let dateMatches = true;
                                    if (searchParams.dateFrom && cellDate < new Date(searchParams.dateFrom)) dateMatches = false;
                                    if (searchParams.dateTo && cellDate > new Date(searchParams.dateTo)) dateMatches = false;
                                    if (dateMatches && (searchParams.dateFrom || searchParams.dateTo)) matchFound = true;
                                }
                            }
                        });
                        
                        if (matchFound) {
                            searchResults.push({
                                tabName: tabName,
                                tabDisplayName: getTabDisplayName(tabName),
                                rowIndex: rowIndex,
                                data: rowData,
                                columns: columns
                            });
                        }
                    });
                });
                
                const endTime = performance.now();
                const searchTime = Math.round(endTime - startTime);
                
                displaySearchResults(searchTime, searchParams);
                
            } catch (error) {
                console.error('Erreur recherche:', error);
                showNotification('‚ùå Erreur lors de la recherche', 'error');
            }
        }

        function performAdvancedSearch() {
            try {
                const advancedOptions = document.getElementById('advancedSearchOptions');
                if (advancedOptions.style.display === 'none') {
                    advancedOptions.style.display = 'block';
                    showNotification('üéØ Options de recherche avanc√©e activ√©es', 'info');
                } else {
                    advancedOptions.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur recherche avanc√©e:', error);
            }
        }

        function displaySearchResults(searchTime, searchParams) {
            try {
                const resultsContainer = document.getElementById('searchResults');
                const resultsHead = document.getElementById('searchResultsHead');
                const resultsBody = document.getElementById('searchResultsBody');
                const resultsCount = document.getElementById('searchResultsCount');
                const searchTimeElement = document.getElementById('searchTime');
                const searchCriteriaElement = document.getElementById('searchCriteria');
                
                resultsCount.textContent = searchResults.length;
                searchTimeElement.textContent = searchTime;
                
                // Construire les crit√®res
                const criteria = [];
                if (searchParams.ga) criteria.push(`GA: ${searchParams.ga}`);
                if (searchParams.rg) criteria.push(`RG: ${searchParams.rg}`);
                if (searchParams.utbat) criteria.push(`UT-BAT: ${searchParams.utbat}`);
                if (searchParams.bail) criteria.push(`Bail: ${searchParams.bail}`);
                if (searchParams.advancedBail) criteria.push(`Bail (avanc√©): ${searchParams.advancedBail}`);
                if (searchParams.keyword) criteria.push(`Mot-cl√©: ${searchParams.keyword}`);
                searchCriteriaElement.textContent = criteria.length > 0 ? criteria.join(', ') : 'Tous';
                
                if (searchResults.length === 0) {
                    resultsContainer.style.display = 'none';
                    showNotification('‚ÑπÔ∏è Aucun r√©sultat trouv√©', 'warning');
                    document.getElementById('saveSearchBtn').disabled = true;
                    return;
                }
                
                // En-t√™te
                resultsHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
                    <th style="width: 40px;">#</th>
                    <th style="width: 150px;">Onglet</th>
                    <th style="width: 80px;">GA</th>
                    <th style="width: 120px;">Date</th>
                    <th style="width: 80px;">RG</th>
                    <th style="width: 120px;">Bail</th>
                    <th style="width: 100px;">UT-BAT</th>
                    <th style="width: 200px;">D√©tails</th>
                    <th style="width: 100px;">Action</th>
                `;
                resultsHead.appendChild(headerRow);
                
                // Corps
                resultsBody.innerHTML = '';
                searchResults.forEach((result, index) => {
                    const row = document.createElement('tr');
                    row.className = 'result-row';
                    
                    const ga = result.data[result.columns.indexOf('GA')] || '';
                    const date = result.data[result.columns.indexOf('Date Demande')] || result.data[result.columns.indexOf('Date')] || '';
                    const rg = result.data[result.columns.indexOf('RG')] || result.data[result.columns.indexOf('Code RG')] || '';
                    const bail = result.data[result.columns.findIndex(col => col.includes('Bail'))] || '';
                    const utbat = result.data[result.columns.indexOf('UT-BAT')] || '';
                    const details = result.data.slice(0, 3).join(' | ');
                    
                    row.innerHTML = `
                        <td class="row-number">${index + 1}</td>
                        <td><span style="color: #667eea;">${getTabIcon(result.tabName)} ${result.tabDisplayName}</span></td>
                        <td>${ga}</td>
                        <td>${date}</td>
                        <td>${rg}</td>
                        <td>${bail}</td>
                        <td>${utbat}</td>
                        <td style="font-size: 12px; color: #666;">${details}</td>
                        <td>
                            <button class="btn" style="padding: 4px 8px; font-size: 11px;" 
                                    onclick="goToResult('${result.tabName}', ${result.rowIndex})">
                                üîó Aller √†
                            </button>
                        </td>
                    `;
                    
                    resultsBody.appendChild(row);
                });
                
                resultsContainer.style.display = 'block';
                document.getElementById('saveSearchBtn').disabled = false;
                showNotification(`üîç ${searchResults.length} r√©sultat(s) trouv√©(s) en ${searchTime}ms`);
                
            } catch (error) {
                console.error('Erreur affichage r√©sultats:', error);
                showNotification('‚ùå Erreur lors de l\'affichage des r√©sultats', 'error');
            }
        }

        function goToResult(tabName, rowIndex) {
            try {
                switchTab(tabName);
                
                setTimeout(() => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (tbody) {
                        const rows = tbody.querySelectorAll('tr');
                        if (rows[rowIndex]) {
                            rows[rowIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            rows[rowIndex].classList.add('highlight-result');
                            setTimeout(() => {
                                rows[rowIndex].classList.remove('highlight-result');
                            }, 3000);
                        }
                    }
                }, 200);
                
            } catch (error) {
                console.error('Erreur navigation vers r√©sultat:', error);
                showNotification('‚ùå Erreur lors de la navigation', 'error');
            }
        }

        function clearSearch() {
            try {
                document.getElementById('searchGA').value = '';
                document.getElementById('searchRG').value = '';
                document.getElementById('searchUTBAT').value = '';
                document.getElementById('searchBail').value = '';
                const advancedBailInput = document.getElementById('advancedSearchBail');
                if (advancedBailInput) advancedBailInput.value = '';
                document.getElementById('searchDateFrom').value = '';
                document.getElementById('searchDateTo').value = '';
                document.getElementById('searchTab').value = '';
                document.getElementById('searchKeyword').value = '';
                
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('saveSearchBtn').disabled = true;
                searchResults = [];
                
                showNotification('üóëÔ∏è Crit√®res de recherche effac√©s');
                
            } catch (error) {
                console.error('Erreur effacement recherche:', error);
            }
        }

        function saveCurrentSearch() {
            try {
                if (searchResults.length === 0) {
                    showNotification('‚ùå Aucune recherche √† sauvegarder', 'error');
                    return;
                }
                
                const searchName = prompt('Nom de la recherche sauvegard√©e:');
                if (!searchName) return;
                
                const searchParams = {
                    ga: document.getElementById('searchGA').value,
                    rg: document.getElementById('searchRG').value,
                    utbat: document.getElementById('searchUTBAT').value,
                    bail: document.getElementById('searchBail').value,
                    advancedBail: document.getElementById('advancedSearchBail')?.value || '',
                    dateFrom: document.getElementById('searchDateFrom').value,
                    dateTo: document.getElementById('searchDateTo').value,
                    tab: document.getElementById('searchTab').value,
                    keyword: document.getElementById('searchKeyword').value
                };
                
                const savedSearch = {
                    id: generateUniqueId(),
                    name: searchName,
                    params: searchParams,
                    createdAt: new Date(),
                    resultCount: searchResults.length
                };
                
                savedSearches.push(savedSearch);
                updateSavedSearchesDisplay();
                saveAllData();
                
                showNotification(`üíæ Recherche "${searchName}" sauvegard√©e`);
                
            } catch (error) {
                console.error('Erreur sauvegarde recherche:', error);
                showNotification('‚ùå Erreur lors de la sauvegarde', 'error');
            }
        }

        function updateSavedSearchesDisplay() {
            try {
                const container = document.getElementById('savedSearches');
                if (!container) return;
                
                if (savedSearches.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Aucune recherche sauvegard√©e.</p>';
                    return;
                }
                
                const html = savedSearches.map(search => {
                    const date = search.createdAt.toLocaleDateString('fr-FR');
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600;">${search.name}</div>
                                <div style="font-size: 12px; color: #666;">${search.resultCount} r√©sultat(s) ‚Ä¢ ${date}</div>
                            </div>
                            <div>
                                <button class="btn" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;" onclick="loadSavedSearch('${search.id}')">
                                    üîç Charger
                                </button>
                                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteSavedSearch('${search.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Erreur affichage recherches sauvegard√©es:', error);
            }
        }

        function loadSavedSearch(searchId) {
            try {
                const search = savedSearches.find(s => s.id === searchId);
                if (!search) return;
                
                // Charger les param√®tres
                document.getElementById('searchGA').value = search.params.ga || '';
                document.getElementById('searchRG').value = search.params.rg || '';
                document.getElementById('searchUTBAT').value = search.params.utbat || '';
                document.getElementById('searchBail').value = search.params.bail || '';
                const advancedBailInput = document.getElementById('advancedSearchBail');
                if (advancedBailInput) advancedBailInput.value = search.params.advancedBail || '';
                document.getElementById('searchDateFrom').value = search.params.dateFrom || '';
                document.getElementById('searchDateTo').value = search.params.dateTo || '';
                document.getElementById('searchTab').value = search.params.tab || '';
                document.getElementById('searchKeyword').value = search.params.keyword || '';
                
                // Ex√©cuter la recherche
                performSearch();
                
                showNotification(`üîç Recherche "${search.name}" charg√©e`);
                
            } catch (error) {
                console.error('Erreur chargement recherche:', error);
                showNotification('‚ùå Erreur lors du chargement', 'error');
            }
        }

        function deleteSavedSearch(searchId) {
            try {
                if (confirm('Supprimer cette recherche sauvegard√©e ?')) {
                    savedSearches = savedSearches.filter(s => s.id !== searchId);
                    updateSavedSearchesDisplay();
                    saveAllData();
                    showNotification('üóëÔ∏è Recherche sauvegard√©e supprim√©e');
                }
            } catch (error) {
                console.error('Erreur suppression recherche:', error);
            }
        }

        function exportSearchResults() {
            try {
                if (searchResults.length === 0) {
                    showNotification('‚ùå Aucun r√©sultat √† exporter', 'error');
                    return;
                }
                
                if (!window.XLSX) {
                    showNotification('‚ùå Biblioth√®que Excel non disponible', 'error');
                    return;
                }
                
                const wsData = [['#', 'Onglet', 'GA', 'Date', 'RG', 'Bail', 'UT-BAT', 'D√©tails']];
                
                searchResults.forEach((result, index) => {
                    const ga = result.data[result.columns.indexOf('GA')] || '';
                    const date = result.data[result.columns.indexOf('Date Demande')] || '';
                    const rg = result.data[result.columns.indexOf('RG')] || '';
                    const bail = result.data[result.columns.findIndex(col => col.includes('Bail'))] || '';
                    const utbat = result.data[result.columns.indexOf('UT-BAT')] || '';
                    const details = result.data.join(' | ');
                    
                    wsData.push([
                        index + 1,
                        result.tabDisplayName,
                        ga,
                        date,
                        rg,
                        bail,
                        utbat,
                        details
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'R√©sultats de recherche');
                
                const fileName = `MARTINE_Recherche_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`üìä R√©sultats export√©s: ${fileName}`);
                
            } catch (error) {
                console.error('Erreur export r√©sultats:', error);
                showNotification('‚ùå Erreur lors de l\'export', 'error');
            }
        }

        // üìù GESTION DES T√ÇCHES COMPL√àTE
        function updateTaskFields() {
            try {
                const targetTab = document.getElementById('taskTargetTab').value;
                const fieldsContainer = document.getElementById('taskFieldsContainer');
                const transferBtn = document.getElementById('transferTaskBtn');
                const pendingBtn = document.getElementById('pendingTaskBtn');
                const batchBtn = document.getElementById('batchTaskBtn');

                if (!targetTab) {
                    fieldsContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">S√©lectionnez un onglet pour voir les champs disponibles</p>';
                    transferBtn.disabled = true;
                    pendingBtn.disabled = true;
                    batchBtn.disabled = true;
                    return;
                }
                
                const columns = tabConfigs[targetTab]?.columns || [];
                fieldsContainer.innerHTML = '';
                
                columns.forEach((column, index) => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'task-field';
                    
                    const label = document.createElement('label');
                    label.textContent = column;
                    
                    const input = document.createElement('input');
                    input.type = getInputType(column);
                    input.placeholder = `Saisir ${column.toLowerCase()}...`;
                    input.id = `taskField_${index}`;
                    
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    fieldsContainer.appendChild(fieldDiv);
                });

                transferBtn.disabled = false;
                pendingBtn.disabled = false;
                batchBtn.disabled = false;
                
            } catch (error) {
                console.error('Erreur mise √† jour champs t√¢che:', error);
            }
        }

        function transferTask() {
            try {
                const targetTab = document.getElementById('taskTargetTab').value;
                if (!targetTab) return;
                
                const columns = tabConfigs[targetTab]?.columns || [];
                const taskData = [];
                
                columns.forEach((column, index) => {
                    const input = document.getElementById(`taskField_${index}`);
                    taskData.push(input ? input.value : '');
                });
                
                addRowWithData(targetTab, taskData);
                updateStats(targetTab);
                saveAllData();
                
                clearTaskForm();
                
                showNotification(`‚úÖ T√¢che transf√©r√©e vers ${getTabDisplayName(targetTab)}`);
                logActivity(`T√¢che transf√©r√©e vers ${getTabDisplayName(targetTab)}`, 'success');
                
            } catch (error) {
                console.error('Erreur transfert t√¢che:', error);
                showNotification('‚ùå Erreur lors du transfert de t√¢che', 'error');
            }
        }

        function saveTaskAsPending() {
            try {
                const targetTab = document.getElementById('taskTargetTab').value;
                if (!targetTab) return;

                const columns = tabConfigs[targetTab]?.columns || [];
                const taskData = {};
                
                columns.forEach((column, index) => {
                    const input = document.getElementById(`taskField_${index}`);
                    taskData[column] = input ? input.value : '';
                });
                
                const task = {
                    id: generateUniqueId(),
                    targetTab: targetTab,
                    targetTabName: getTabDisplayName(targetTab),
                    data: taskData,
                    createdAt: new Date(),
                    priority: 'Normale',
                    summary: generateTaskSummary(taskData)
                };
                
                pendingTasks.push(task);
                updatePendingTasksDisplay();
                updateTasksStats();
                saveAllData();
                
                clearTaskForm();
                
                showNotification('‚è≥ T√¢che mise en attente');
                logActivity(`T√¢che mise en attente pour ${getTabDisplayName(targetTab)}`, 'info');
                
            } catch (error) {
                console.error('Erreur sauvegarde t√¢che en attente:', error);
                showNotification('‚ùå Erreur lors de la sauvegarde de t√¢che', 'error');
            }
        }

        function addTaskToBatch() {
            try {
                const targetTab = document.getElementById('taskTargetTab').value;
                if (!targetTab) return;

                const columns = tabConfigs[targetTab]?.columns || [];
                const taskData = {};

                columns.forEach((column, index) => {
                    const input = document.getElementById(`taskField_${index}`);
                    taskData[column] = input ? input.value : '';
                });

                const task = {
                    id: generateUniqueId(),
                    targetTab,
                    targetTabName: getTabDisplayName(targetTab),
                    data: taskData,
                    createdAt: new Date(),
                    priority: 'Normale',
                    summary: generateTaskSummary(taskData)
                };

                taskDrafts.push(task);
                updateTaskBatchDisplay();
                saveAllData();

                clearTaskForm();

                showNotification('‚ûï T√¢che ajout√©e au lot de cr√©ation');
                logActivity(`T√¢che ajout√©e au lot (${task.targetTabName})`, 'info');

            } catch (error) {
                console.error('Erreur ajout t√¢che au lot:', error);
                showNotification('‚ùå Erreur lors de l\'ajout au lot', 'error');
            }
        }

        function clearTaskForm() {
            try {
                document.getElementById('taskTargetTab').value = '';
                updateTaskFields();
            } catch (error) {
                console.error('Erreur effacement formulaire t√¢che:', error);
            }
        }

        function generateTaskSummary(taskData) {
            const importantFields = ['GA', 'RG', 'Code RG', 'Num√©ro de Bail', 'UT-BAT'];
            const summary = [];
            
            importantFields.forEach(field => {
                if (taskData[field]) {
                    summary.push(`${field}: ${taskData[field]}`);
                }
            });
            
            return summary.join(' | ') || 'T√¢che sans d√©tails sp√©cifiques';
        }

        function updatePendingTasksDisplay() {
            try {
                const tbody = document.getElementById('tachesTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (pendingTasks.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                üìù Aucune t√¢che en attente. Cr√©ez une nouvelle t√¢che ci-dessus !
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                pendingTasks.forEach((task, index) => {
                    const row = document.createElement('tr');
                    
                    const createdDate = task.createdAt.toLocaleDateString('fr-FR');
                    
                    row.innerHTML = `
                        <td class="row-number">${index + 1}</td>
                        <td>${getTabIcon(task.targetTab)} ${task.targetTabName}</td>
                        <td style="font-size: 13px;">${task.summary}</td>
                        <td>${createdDate}</td>
                        <td><span style="color: #667eea;">${task.priority}</span></td>
                        <td>
                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;" 
                                    onclick="executeTask('${task.id}')">
                                üöÄ Ex√©cuter
                            </button>
                            <button class="btn btn-warning" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;" 
                                    onclick="editTask('${task.id}')">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" 
                                    onclick="deleteTask('${task.id}')">
                                üóëÔ∏è
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Erreur mise √† jour affichage t√¢ches:', error);
            }
        }

        function updateTaskBatchDisplay() {
            try {
                const tbody = document.getElementById('taskBatchTableBody');
                const createBtn = document.getElementById('createBatchTasksBtn');
                if (!tbody || !createBtn) return;

                tbody.innerHTML = '';

                if (taskDrafts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">‚ûï Ajoutez des t√¢ches pour constituer un lot.</td>
                        </tr>
                    `;
                    createBtn.disabled = true;
                    return;
                }

                taskDrafts.forEach((task, index) => {
                    const row = document.createElement('tr');
                    const createdDate = task.createdAt.toLocaleDateString('fr-FR');

                    row.innerHTML = `
                        <td class="row-number">${index + 1}</td>
                        <td>${getTabIcon(task.targetTab)} ${task.targetTabName}</td>
                        <td style="font-size: 13px;">${task.summary}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteTaskDraft('${task.id}')">üóëÔ∏è Supprimer</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                createBtn.disabled = false;
            } catch (error) {
                console.error('Erreur mise √† jour lot t√¢ches:', error);
            }
        }

        function deleteTaskDraft(taskId) {
            try {
                taskDrafts = taskDrafts.filter(task => task.id !== taskId);
                updateTaskBatchDisplay();
                saveAllData();
            } catch (error) {
                console.error('Erreur suppression t√¢che du lot:', error);
                showNotification('‚ùå Erreur lors de la suppression du lot', 'error');
            }
        }

        function saveBatchAsPending() {
            try {
                if (taskDrafts.length === 0) return;

                const addedCount = taskDrafts.length;

                taskDrafts.forEach(task => {
                    pendingTasks.push({
                        ...task,
                        createdAt: task.createdAt || new Date()
                    });
                });

                taskDrafts = [];

                updateTaskBatchDisplay();
                updatePendingTasksDisplay();
                updateTasksStats();
                saveAllData();

                showNotification(`‚úÖ ${addedCount} t√¢che(s) ajout√©e(s) en attente`);
                logActivity(`${addedCount} t√¢che(s) ajout√©e(s) depuis le lot`, 'success');

            } catch (error) {
                console.error('Erreur cr√©ation lot de t√¢ches:', error);
                showNotification('‚ùå Erreur lors de la cr√©ation du lot', 'error');
            }
        }

        function updateTasksStats() {
            try {
                const pendingCount = pendingTasks.length;
                const completedCount = completedTasks.length;
                const totalCount = pendingCount + completedCount;
                const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                document.getElementById('pendingTasksCount').textContent = pendingCount;
                document.getElementById('completedTasksCount').textContent = completedCount;
                document.getElementById('totalTasksCount').textContent = totalCount;
                document.getElementById('tasksProgress').style.width = completionRate + '%';
                
            } catch (error) {
                console.error('Erreur mise √† jour stats t√¢ches:', error);
            }
        }

        function executeTask(taskId) {
            try {
                const task = pendingTasks.find(t => t.id === taskId);
                if (!task) return;
                
                const columns = tabConfigs[task.targetTab]?.columns || [];
                const taskDataArray = columns.map(column => task.data[column] || '');
                
                addRowWithData(task.targetTab, taskDataArray);
                
                // D√©placer vers les t√¢ches compl√©t√©es
                completedTasks.push({
                    ...task,
                    completedAt: new Date(),
                    status: 'completed'
                });
                
                pendingTasks = pendingTasks.filter(t => t.id !== taskId);
                
                updateStats(task.targetTab);
                updatePendingTasksDisplay();
                updateTasksStats();
                saveAllData();
                
                showNotification(`‚úÖ T√¢che ex√©cut√©e vers ${task.targetTabName}`);
                logActivity(`T√¢che ex√©cut√©e vers ${task.targetTabName}`, 'success');
                
            } catch (error) {
                console.error('Erreur ex√©cution t√¢che:', error);
                showNotification('‚ùå Erreur lors de l\'ex√©cution de t√¢che', 'error');
            }
        }

        function editTask(taskId) {
            try {
                const task = pendingTasks.find(t => t.id === taskId);
                if (!task) return;
                
                // Charger la t√¢che dans le formulaire
                document.getElementById('taskTargetTab').value = task.targetTab;
                updateTaskFields();
                
                // Remplir les champs
                setTimeout(() => {
                    const columns = tabConfigs[task.targetTab]?.columns || [];
                    columns.forEach((column, index) => {
                        const input = document.getElementById(`taskField_${index}`);
                        if (input && task.data[column]) {
                            input.value = task.data[column];
                        }
                    });
                }, 100);
                
                // Supprimer l'ancienne t√¢che
                pendingTasks = pendingTasks.filter(t => t.id !== taskId);
                updatePendingTasksDisplay();
                updateTasksStats();
                
                showNotification('‚úèÔ∏è T√¢che charg√©e pour modification');
                
            } catch (error) {
                console.error('Erreur modification t√¢che:', error);
                showNotification('‚ùå Erreur lors de la modification', 'error');
            }
        }

        function deleteTask(taskId) {
            try {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')) {
                    pendingTasks = pendingTasks.filter(t => t.id !== taskId);
                    updatePendingTasksDisplay();
                    updateTasksStats();
                    saveAllData();
                    showNotification('üóëÔ∏è T√¢che supprim√©e');
                    logActivity('T√¢che supprim√©e', 'warning');
                }
            } catch (error) {
                console.error('Erreur suppression t√¢che:', error);
                showNotification('‚ùå Erreur lors de la suppression de t√¢che', 'error');
            }
        }

        function executeAllPendingTasks() {
            try {
                if (pendingTasks.length === 0) {
                    showNotification('‚ÑπÔ∏è Aucune t√¢che en attente', 'info');
                    return;
                }
                
                if (!confirm(`Ex√©cuter toutes les ${pendingTasks.length} t√¢che(s) en attente ?`)) {
                    return;
                }
                
                let executed = 0;
                const tasksToExecute = [...pendingTasks];
                
                tasksToExecute.forEach(task => {
                    const columns = tabConfigs[task.targetTab]?.columns || [];
                    const taskDataArray = columns.map(column => task.data[column] || '');
                    
                    addRowWithData(task.targetTab, taskDataArray);
                    updateStats(task.targetTab);
                    
                    completedTasks.push({
                        ...task,
                        completedAt: new Date(),
                        status: 'completed'
                    });
                    
                    executed++;
                });
                
                pendingTasks = [];
                updatePendingTasksDisplay();
                updateTasksStats();
                saveAllData();
                
                showNotification(`üöÄ ${executed} t√¢che(s) ex√©cut√©e(s) avec succ√®s`);
                logActivity(`${executed} t√¢ches ex√©cut√©es en lot`, 'success');
                
            } catch (error) {
                console.error('Erreur ex√©cution toutes t√¢ches:', error);
                showNotification('‚ùå Erreur lors de l\'ex√©cution des t√¢ches', 'error');
            }
        }

        function clearAllPendingTasks() {
            try {
                if (pendingTasks.length === 0) {
                    showNotification('‚ÑπÔ∏è Aucune t√¢che √† effacer', 'info');
                    return;
                }
                
                if (!confirm(`Supprimer toutes les ${pendingTasks.length} t√¢che(s) en attente ?`)) {
                    return;
                }
                
                const count = pendingTasks.length;
                pendingTasks = [];
                updatePendingTasksDisplay();
                updateTasksStats();
                saveAllData();
                
                showNotification(`üóëÔ∏è ${count} t√¢che(s) supprim√©e(s)`);
                logActivity(`${count} t√¢ches supprim√©es`, 'warning');
                
            } catch (error) {
                console.error('Erreur suppression toutes t√¢ches:', error);
                showNotification('‚ùå Erreur lors de la suppression', 'error');
            }
        }

        // üîß FONCTIONS SP√âCIALIS√âES PAR ONGLET
        function validateAllBauxStates() {
            try {
                const tbody = document.getElementById('verifbauxTableBody');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                let validated = 0;
                let errors = 0;
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const etatIndex = tabConfigs['verifbaux'].columns.indexOf('√âtat');
                    const etatInput = inputs[etatIndex];
                    
                    if (etatInput) {
                        const etat = etatInput.value.toUpperCase();
                        if (['OK', 'NOK', 'EN COURS'].includes(etat)) {
                            etatInput.classList.remove('has-error');
                            etatInput.classList.add('has-success');
                            validated++;
                        } else if (etat) {
                            etatInput.classList.add('has-error');
                            errors++;
                        }
                    }
                });
                
                updateStats('verifbaux');
                
                if (errors > 0) {
                    showNotification(`‚ö†Ô∏è ${validated} √©tat(s) valid√©(s), ${errors} erreur(s) d√©tect√©e(s)`, 'warning');
                } else {
                    showNotification(`‚úÖ ${validated} √©tat(s) valid√©(s) avec succ√®s`);
                }
                
            } catch (error) {
                console.error('Erreur validation √©tats baux:', error);
                showNotification('‚ùå Erreur lors de la validation', 'error');
            }
        }

        function markAllAsOK() {
            try {
                const tbody = document.getElementById('verifbauxTableBody');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                let marked = 0;
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const etatIndex = tabConfigs['verifbaux'].columns.indexOf('√âtat');
                    const etatInput = inputs[etatIndex];
                    
                    if (etatInput && !etatInput.value) {
                        etatInput.value = 'OK';
                        etatInput.classList.remove('has-error', 'has-warning');
                        marked++;
                    }
                });
                
                if (marked > 0) {
                    updateStats('verifbaux');
                    saveAllData();
                    showNotification(`‚úÖ ${marked} ligne(s) marqu√©e(s) comme OK`);
                } else {
                    showNotification('‚ÑπÔ∏è Aucune ligne vide √† marquer', 'info');
                }
                
            } catch (error) {
                console.error('Erreur marquage OK:', error);
                showNotification('‚ùå Erreur lors du marquage', 'error');
            }
        }

        function validateAllRGCodes() {
            try {
                if (Object.keys(rgDatabase).length === 0) {
                    showNotification('‚ö†Ô∏è Base RG vide. Importez d\'abord la base RG.', 'warning');
                    return;
                }
                
                let invalidCodes = [];
                let validCodes = 0;
                let checkedTabs = 0;
                
                ['creation', 'modification', 'verifbaux'].forEach(tabName => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;
                    
                    checkedTabs++;
                    const rows = tbody.querySelectorAll('tr');
                    const columns = tabConfigs[tabName]?.columns || [];
                    const rgIndex = columns.indexOf('RG');
                    
                    if (rgIndex >= 0) {
                        rows.forEach((row, rowIndex) => {
                            const inputs = row.querySelectorAll('input, textarea');
                            const rgInput = inputs[rgIndex];
                            
                            if (rgInput && rgInput.value) {
                                if (rgDatabase[rgInput.value]) {
                                    rgInput.classList.remove('has-error');
                                    rgInput.classList.add('has-success');
                                    validCodes++;
                                } else {
                                    rgInput.classList.add('has-error');
                                    invalidCodes.push({
                                        tab: getTabDisplayName(tabName),
                                        row: rowIndex + 1,
                                        code: rgInput.value
                                    });
                                }
                            }
                        });
                    }
                });
                
                if (invalidCodes.length === 0) {
                    showNotification(`‚úÖ Tous les ${validCodes} code(s) RG sont valides`);
                } else {
                    let message = `‚ö†Ô∏è ${invalidCodes.length} code(s) RG invalide(s), ${validCodes} valide(s):\n\n`;
                    invalidCodes.slice(0, 10).forEach(item => {
                        message += `‚Ä¢ ${item.tab} - Ligne ${item.row}: ${item.code}\n`;
                    });
                    if (invalidCodes.length > 10) {
                        message += `\n... et ${invalidCodes.length - 10} autre(s)`;
                    }
                    alert(message);
                }
                
            } catch (error) {
                console.error('Erreur validation codes RG:', error);
                showNotification('‚ùå Erreur lors de la validation des codes RG', 'error');
            }
        }

        // üìä EXPORT EXCEL COMPLET
        function exportToExcel(tabName) {
            try {
                if (!window.XLSX) {
                    showNotification('‚ùå Biblioth√®que Excel non disponible', 'error');
                    return;
                }
                
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (!tbody) return;
                
                const columns = tabConfigs[tabName]?.columns || [];
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    showNotification('‚ùå Aucune donn√©e √† exporter', 'error');
                    return;
                }
                
                const wsData = [columns];
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const rowData = [];
                    inputs.forEach(input => {
                        rowData.push(input.value || '');
                    });
                    if (rowData.some(cell => cell.trim() !== '')) {
                        wsData.push(rowData);
                    }
                });
                
                if (wsData.length <= 1) {
                    showNotification('‚ùå Aucune donn√©e valide √† exporter', 'error');
                    return;
                }
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, getTabDisplayName(tabName));
                
                const fileName = `MARTINE_${getTabDisplayName(tabName).replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`üìä Export Excel r√©ussi: ${fileName}`);
                logActivity(`Export Excel de ${getTabDisplayName(tabName)}`, 'success');
                
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showNotification('‚ùå Erreur lors de l\'export Excel', 'error');
            }
        }

        function exportAllToExcel() {
            try {
                if (!window.XLSX) {
                    showNotification('‚ùå Biblioth√®que Excel non disponible', 'error');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                let hasData = false;
                
                Object.keys(tabConfigs).forEach(tabName => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;
                    
                    const columns = tabConfigs[tabName]?.columns || [];
                    const rows = tbody.querySelectorAll('tr');
                    
                    if (rows.length === 0) return;
                    
                    const wsData = [columns];
                    
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const rowData = [];
                        inputs.forEach(input => {
                            rowData.push(input.value || '');
                        });
                        if (rowData.some(cell => cell.trim() !== '')) {
                            wsData.push(rowData);
                        }
                    });
                    
                    if (wsData.length > 1) {
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        const sheetName = getTabDisplayName(tabName).substring(0, 31); // Limite Excel
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                        hasData = true;
                    }
                });
                
                if (!hasData) {
                    showNotification('‚ùå Aucune donn√©e √† exporter', 'error');
                    return;
                }
                
                const fileName = `MARTINE_Export_Global_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`üìä Export global r√©ussi: ${fileName}`);
                logActivity('Export global Excel de tous les onglets', 'success');
                
            } catch (error) {
                console.error('Erreur export global:', error);
                showNotification('‚ùå Erreur lors de l\'export global', 'error');
            }
        }

        function exportStatsReport() {
            try {
                if (!window.XLSX) {
                    showNotification('‚ùå Biblioth√®que Excel non disponible', 'error');
                    return;
                }

                const statsData = getTabStatistics();
                const qualityCounts = getQualityCounts();
                const rgInsights = getRGChangeInsights();

                const wb = XLSX.utils.book_new();

                const summaryData = [
                    ['M√©trique', 'Valeur'],
                    ['Total entr√©es', statsData.general.total],
                    ['Trait√©es', statsData.general.traites],
                    ['En attente', statsData.general.attente],
                    ['Taux global', `${statsData.general.taux}%`],
                    ['UT-BAT surveill√©s', rgInsights.utbatCount],
                    ['Changements multiples', rgInsights.multiCount],
                    ['Erreurs qualit√©', qualityCounts.errors],
                    ['Avertissements qualit√©', qualityCounts.warnings],
                    ['Export g√©n√©r√© le', new Date().toLocaleString('fr-FR')]
                ];

                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, 'Synth√®se');

                const perTabData = [['Onglet', 'Total', 'Trait√©s', 'En attente', 'Taux']];
                statsData.perTab.forEach(stat => {
                    perTabData.push([
                        getTabDisplayName(stat.tabName),
                        stat.total,
                        stat.processed,
                        stat.pending,
                        `${stat.rate}%`
                    ]);
                });

                const perTabSheet = XLSX.utils.aoa_to_sheet(perTabData);
                XLSX.utils.book_append_sheet(wb, perTabSheet, 'Par onglet');

                const rgData = [['UT-BAT', 'Occurrences', 'Variations RG']];
                if (rgInsights.topChanges.length === 0) {
                    rgData.push(['Aucun doublon d√©tect√©', '', '']);
                } else {
                    rgInsights.topChanges.forEach(change => {
                        rgData.push([change.utbat, change.occurrences, change.variations]);
                    });
                }

                const rgSheet = XLSX.utils.aoa_to_sheet(rgData);
                XLSX.utils.book_append_sheet(wb, rgSheet, 'Changements RG');

                const fileName = `MARTINE_Stats_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification(`üìä Rapport statistiques export√©: ${fileName}`);
                logActivity('Export du rapport statistiques', 'success');

            } catch (error) {
                console.error('Erreur export rapport statistiques:', error);
                showNotification('‚ùå Erreur lors de l\'export du rapport', 'error');
            }
        }

        // üíæ SAUVEGARDE ET RESTAURATION COMPL√àTE
        function saveAllData() {
            try {
                const allData = {
                    version: '17.0',
                    timestamp: new Date().toISOString(),
                    rowCounters: rowCounters,
                    rgDatabase: rgDatabase,
                    pendingTasks: pendingTasks,
                    taskDrafts: taskDrafts,
                    completedTasks: completedTasks,
                    savedSearches: savedSearches,
                    activityLog: activityLog,
                    tabsData: {}
                };
                
                Object.keys(tabConfigs).forEach(tabName => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;
                    
                    const rows = tbody.querySelectorAll('tr');
                    const tabData = [];
                    
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const rowData = [];
                        inputs.forEach(input => {
                            rowData.push(input.value || '');
                        });
                        if (rowData.some(cell => cell.trim() !== '')) {
                            tabData.push(rowData);
                        }
                    });
                    
                    allData.tabsData[tabName] = tabData;
                });
                
                localStorage.setItem('martine_v17_data', JSON.stringify(allData));
                showSaveStatus('üíæ Donn√©es sauvegard√©es');
                
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showSaveStatus('‚ùå Erreur sauvegarde', 'error');
            }
        }

        function loadAllData() {
            try {
                const savedData = localStorage.getItem('martine_v17_data');
                if (!savedData) return;

                let data;
                try {
                    data = JSON.parse(savedData);
                } catch (parseError) {
                    console.error('Sauvegarde corrompue, suppression...', parseError);
                    localStorage.removeItem('martine_v17_data');
                    showNotification('‚ö†Ô∏è Sauvegarde corrompue supprim√©e. Nouvelle session propre.', 'warning');
                    return;
                }

                if (!data || typeof data !== 'object') {
                    showNotification('‚ö†Ô∏è Format de sauvegarde invalide. Donn√©es ignor√©es.', 'warning');
                    return;
                }

                applyLoadedState(data);

                showNotification('üíæ Donn√©es restaur√©es avec succ√®s');

            } catch (error) {
                console.error('Erreur chargement:', error);
                showNotification('‚ùå Erreur lors du chargement des donn√©es', 'error');
            }
        }

        function exportCompleteBackup() {
            try {
                const allData = {
                    version: '17.0',
                    timestamp: new Date().toISOString(),
                    rowCounters: rowCounters,
                    rgDatabase: rgDatabase,
                    pendingTasks: pendingTasks,
                    taskDrafts: taskDrafts,
                    completedTasks: completedTasks,
                    savedSearches: savedSearches,
                    activityLog: activityLog,
                    tabsData: {}
                };
                
                Object.keys(tabConfigs).forEach(tabName => {
                    const tbody = document.getElementById(`${tabName}TableBody`);
                    if (!tbody) return;
                    
                    const rows = tbody.querySelectorAll('tr');
                    const tabData = [];
                    
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const rowData = [];
                        inputs.forEach(input => {
                            rowData.push(input.value || '');
                        });
                        if (rowData.some(cell => cell.trim() !== '')) {
                            tabData.push(rowData);
                        }
                    });
                    
                    allData.tabsData[tabName] = tabData;
                });
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `MARTINE_Sauvegarde_Compl√®te_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('üì§ Sauvegarde compl√®te t√©l√©charg√©e');
                logActivity('Sauvegarde compl√®te export√©e', 'success');
                
            } catch (error) {
                console.error('Erreur export sauvegarde:', error);
                showNotification('‚ùå Erreur lors de l\'export de sauvegarde', 'error');
            }
        }

        function importCompleteBackup() {
            const fileInput = document.getElementById('backupFileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleBackupImport() {
            try {
                const fileInput = document.getElementById('backupFileInput');
                const file = fileInput.files[0];
                
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    showNotification('‚ùå Veuillez s√©lectionner un fichier JSON de sauvegarde', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.version || !data.tabsData) {
                            showNotification('‚ùå Fichier de sauvegarde invalide', 'error');
                            return;
                        }
                        
                        if (!confirm('‚ö†Ô∏è Cette action remplacera toutes les donn√©es actuelles. Continuer ?')) {
                            return;
                        }
                        
                        // Effacer les donn√©es actuelles
                        Object.keys(tabConfigs).forEach(tabName => {
                            clearAll(tabName, false);
                        });

                        applyLoadedState(data);
                        
                        showNotification(`‚úÖ Sauvegarde import√©e avec succ√®s (v${data.version})`);
                        logActivity('Sauvegarde compl√®te import√©e', 'success');
                        
                    } catch (parseError) {
                        console.error('Erreur parsing JSON:', parseError);
                        showNotification('‚ùå Erreur lors de la lecture du fichier de sauvegarde', 'error');
                    }
                };
                
                reader.readAsText(file);
                fileInput.value = '';
                
            } catch (error) {
                console.error('Erreur import sauvegarde:', error);
                showNotification('‚ùå Erreur lors de l\'import de sauvegarde', 'error');
            }
        }

        function applyLoadedState(data) {
            if (!data) return;

            columnSuggestions = {};

            // R√©initialiser les tableaux avant rechargement
            Object.keys(tabConfigs).forEach(tabName => {
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (tbody) {
                    tbody.innerHTML = '';
                }
            });

            // R√©initialiser les compteurs pour √©viter les d√©calages
            rowCounters = Object.keys(tabConfigs).reduce((acc, tab) => {
                acc[tab] = 0;
                return acc;
            }, {});

            if (data.rowCounters) {
                Object.keys(data.rowCounters).forEach(tabName => {
                    if (typeof data.rowCounters[tabName] === 'number') {
                        rowCounters[tabName] = 0; // sera recalcul√© lors du chargement
                    }
                });
            }

            rgDatabase = data.rgDatabase || {};
            refreshRGSuggestions();

            pendingTasks = (data.pendingTasks || []).map(task => ({
                ...task,
                createdAt: reviveDate(task.createdAt) || new Date(),
                completedAt: reviveDate(task.completedAt)
            }));

            taskDrafts = (data.taskDrafts || []).map(task => ({
                ...task,
                createdAt: reviveDate(task.createdAt) || new Date()
            }));

            completedTasks = (data.completedTasks || []).map(task => ({
                ...task,
                createdAt: reviveDate(task.createdAt) || new Date(),
                completedAt: reviveDate(task.completedAt) || new Date(),
                status: task.status || 'completed'
            }));

            savedSearches = (data.savedSearches || []).map(search => ({
                ...search,
                createdAt: reviveDate(search.createdAt) || new Date()
            }));

            activityLog = (data.activityLog || []).map(entry => ({
                ...entry,
                timestamp: reviveDate(entry.timestamp) || new Date()
            }));

            if (data.tabsData) {
                Object.keys(data.tabsData).forEach(tabName => {
                    const tabData = data.tabsData[tabName];
                    if (!tabData || tabData.length === 0) return;

                    rowCounters[tabName] = 0;
                    tabData.forEach(rowData => {
                        addRowWithData(tabName, rowData);
                    });

                    updateStats(tabName);
                });
            }

            updatePendingTasksDisplay();
            updateTaskBatchDisplay();
            updateTasksStats();
            updateSavedSearchesDisplay();
            updateRecentActivity();
            rebuildColumnSuggestions();
            saveAllData();
        }

        function reviveDate(value) {
            if (!value) return null;
            const date = new Date(value);
            return isNaN(date.getTime()) ? null : date;
        }

        // üóëÔ∏è NETTOYAGE
        function clearAll(tabName, confirm = true) {
            try {
                if (confirm && !window.confirm(`√ätes-vous s√ªr de vouloir effacer toutes les donn√©es de l'onglet ${getTabDisplayName(tabName)} ?`)) {
                    return;
                }
                
                const tbody = document.getElementById(`${tabName}TableBody`);
                if (tbody) {
                    tbody.innerHTML = '';
                    rowCounters[tabName] = 0;
                    updateStats(tabName);
                    saveAllData();
                    
                    if (confirm) {
                        showNotification(`üóëÔ∏è Toutes les donn√©es de ${getTabDisplayName(tabName)} ont √©t√© effac√©es`);
                        logActivity(`Donn√©es effac√©es dans ${getTabDisplayName(tabName)}`, 'warning');
                    }
                }
            } catch (error) {
                console.error('Erreur effacement:', error);
                showNotification('‚ùå Erreur lors de l\'effacement', 'error');
            }
        }

        // üîß INITIALISATION COMPL√àTE
        function initializeApp() {
            try {
                loadAllData();
                refreshRGSuggestions();

                autoSaveInterval = setInterval(saveAllData, 60000); // Toutes les minutes

                window.addEventListener('beforeunload', () => {
                    saveAllData();
                });

                setupFileDropZones();
                setupActionSounds();
                updateStatsDashboard();

                showNotification('üöÄ MARTINE v17.0 - Tous onglets fonctionnels', 'success');
                showSaveStatus('üíæ Application pr√™te - Auto-sauvegarde activ√©e');
                logActivity('Application MARTINE v17.0 initialis√©e', 'success');
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showNotification('‚ùå Erreur lors de l\'initialisation', 'error');
            }
        }

        function setupFileDropZones() {
            try {
                Object.keys(tabConfigs).forEach(tabName => {
                    const fileInput = document.getElementById(`fileInput${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
                    if (!fileInput) return;
                    
                    const dropZone = fileInput.closest('.file-drop-zone');
                    if (!dropZone) return;
                    
                    // Supprimer les anciens listeners pour √©viter les doublons
                    const newDropZone = dropZone.cloneNode(true);
                    dropZone.parentNode.replaceChild(newDropZone, dropZone);
                    
                    const newFileInput = newDropZone.querySelector('input[type="file"]');
                    
                    newDropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        newDropZone.classList.add('dragover');
                    });
                    
                    newDropZone.addEventListener('dragleave', () => {
                        newDropZone.classList.remove('dragover');
                    });
                    
                    newDropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        newDropZone.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            newFileInput.files = files;
                            handleFileImport(tabName, newFileInput);
                        }
                    });
                    
                    newDropZone.addEventListener('click', (e) => {
                        if (e.target === newDropZone || e.target.closest('.file-drop-zone') === newDropZone) {
                            newFileInput.click();
                        }
                    });
                });
            } catch (error) {
                console.error('Erreur configuration drop zones:', error);
            }
        }

        // üöÄ D√âMARRAGE APPLICATION
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // üîß EXPOSITION DES FONCTIONS GLOBALES
        window.switchTab = switchTab;
        window.addRow = addRow;
        window.deleteRow = deleteRow;
        window.exportToExcel = exportToExcel;
        window.exportAllToExcel = exportAllToExcel;
        window.exportStatsReport = exportStatsReport;
        window.clearAll = clearAll;
        window.triggerFileInput = triggerFileInput;
        window.handleFileImport = handleFileImport;
        window.togglePasteArea = togglePasteArea;
        window.analyzePastedData = analyzePastedData;
        window.showPreview = showPreview;
        window.closePreview = closePreview;
        window.makeEditable = makeEditable;
        window.fixAllErrors = fixAllErrors;
        window.removeErrorRows = removeErrorRows;
        window.importPreviewedData = importPreviewedData;
        window.importIgnoreErrors = importIgnoreErrors;
        window.filterTable = filterTable;
        window.performSearch = performSearch;
        window.performAdvancedSearch = performAdvancedSearch;
        window.clearSearch = clearSearch;
        window.saveCurrentSearch = saveCurrentSearch;
        window.loadSavedSearch = loadSavedSearch;
        window.deleteSavedSearch = deleteSavedSearch;
        window.exportSearchResults = exportSearchResults;
        window.goToResult = goToResult;
        window.updateTaskFields = updateTaskFields;
        window.transferTask = transferTask;
        window.saveTaskAsPending = saveTaskAsPending;
        window.addTaskToBatch = addTaskToBatch;
        window.saveBatchAsPending = saveBatchAsPending;
        window.deleteTaskDraft = deleteTaskDraft;
        window.clearTaskForm = clearTaskForm;
        window.executeTask = executeTask;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.executeAllPendingTasks = executeAllPendingTasks;
        window.clearAllPendingTasks = clearAllPendingTasks;
        window.validateAllBauxStates = validateAllBauxStates;
        window.markAllAsOK = markAllAsOK;
        window.validateAllRGCodes = validateAllRGCodes;
        window.buildRGDatabase = buildRGDatabase;
        window.recalculateAllSurfaces = recalculateAllSurfaces;
        window.exportCompleteBackup = exportCompleteBackup;
        window.importCompleteBackup = importCompleteBackup;
        window.handleBackupImport = handleBackupImport;
    </script>
</body>
</html>